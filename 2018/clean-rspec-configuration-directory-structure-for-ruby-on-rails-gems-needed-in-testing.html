<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Clean RSpec configuration directory structure for Ruby on Rails gems needed in testing</title>
  <meta name="description" content="When your Ruby on Rails project is getting bigger your test suite as well. You need to test more of your business logic and sometimes you will use other gems...">

  <meta property="og:title" content="Clean RSpec configuration directory structure for Ruby on Rails gems needed in testing">
  <meta name="twitter:title" content="Clean RSpec configuration directory structure for Ruby on Rails gems needed in testing">
  <meta name="twitter:description" content="When your Ruby on Rails project is getting bigger your test suite as well. You need to test more of your business logic and sometimes you will use other gems...">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@KnapsackPro">

  
  <meta property="og:image" content="https://docs.knapsackpro.com/images/blog/posts/clean-rspec-configuration-directory-structure-for-ruby-on-rails-gems-needed-in-testing/rspec.jpg">
  <meta name="twitter:image" content="https://docs.knapsackpro.com/images/blog/posts/clean-rspec-configuration-directory-structure-for-ruby-on-rails-gems-needed-in-testing/rspec.jpg">
  

  <link rel="shortcut icon" href="/images/favicon.ico" />
  <link rel="stylesheet" href="/css/main.css?version=1">
  <link rel="canonical" href="https://docs.knapsackpro.com/2018/clean-rspec-configuration-directory-structure-for-ruby-on-rails-gems-needed-in-testing">
  <link rel="alternate" type="application/rss+xml" title="Blog about testing & documentation for KnapsackPro.com" href="https://docs.knapsackpro.com/feed.xml" />
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:100,200,300,400,600,700&amp;subset=latin,latin-ext" type="text/css" rel="stylesheet" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
</head>


  <body>

    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JPGP34N3JJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JPGP34N3JJ');
</script>


    <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.6";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1803263473334711'); // Insert your pixel ID here.
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1803263473334711&ev=PageView&noscript=1"
/></noscript>
<!-- DO NOT MODIFY -->
<!-- End Facebook Pixel Code -->


    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://knapsackpro.com/" rel="nofollow noopener" target="_blank">
      <img src="/images/logo.png" alt="Knapsack Pro Documentation" width="32" height="32">
      Knapsack Pro&nbsp;
    </a>
    <a class="site-title" href="/integration">
      <strong>Docs</strong>
    </a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/">Blog</a>
        <a class="page-link" href="/integration/">Get started with integration</a>
        <a class="page-link" href="/api/">API</a>
        <a class="page-link" href="https://knapsackpro.com">Sign up</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <script>
$(document).ready(function() {
  if (document.cookie.includes("u_source")) {
    return;
  };

  var date = new Date();
  date.setMonth(date.getMonth() + 6);
  var dateString = date.toUTCString();
  var cookieAttributesString = "path=/;domain=knapsackpro.com;expires=" + dateString + ";";
  var utmCampaignString = document.location.pathname.substring(6);

  document.cookie = "u_source=docs_knapsackpro;" + cookieAttributesString;
  document.cookie = "u_medium=blog_post;" + cookieAttributesString;
  document.cookie = "u_campaign=" + utmCampaignString + ";" + cookieAttributesString;
  document.cookie = "u_content=blog_post_pageview;" + cookieAttributesString;
});
</script>


<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Clean RSpec configuration directory structure for Ruby on Rails gems needed in testing</h1>
    <p class="post-meta">
    <time datetime="2018-11-08T11:00:00+00:00" itemprop="datePublished">Nov 8, 2018</time>
     â€¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Artur Trzop</span></span>
    
    </p>
  </header>

  <div class="share-post-container">
  <div class="share-post-left">
    <div class="fb-share-button" data-href="https://docs.knapsackpro.com/2018/clean-rspec-configuration-directory-structure-for-ruby-on-rails-gems-needed-in-testing" data-layout="button_count" data-mobile-iframe="true"></div>

    <a href="https://twitter.com/share" class="twitter-share-button" data-via="KnapsackPro" data-hashtags="">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  </div>

  <div class="share-post-right">
    <a href="https://twitter.com/KnapsackPro" class="twitter-follow-button" data-show-count="false" data-show-screen-name="false">Follow @KnapsackPro</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  </div>
</div>


  <div class="post-content" itemprop="articleBody">
    <p>When your Ruby on Rails project is getting bigger your test suite as well. You need to test more of your business logic and sometimes you will use other gems that can help you with that. Most of the time you may need something like <code class="language-plaintext highlighter-rouge">database_cleaner</code>, <code class="language-plaintext highlighter-rouge">capybara</code> for feature tests or <code class="language-plaintext highlighter-rouge">rspec-sidekiq</code> to test your workers.</p>

<p><img src="/images/blog/posts/clean-rspec-configuration-directory-structure-for-ruby-on-rails-gems-needed-in-testing/rspec.jpg" style="width:250px;margin-left: 15px;float:right;" alt="RSpec, Ruby" /></p>

<p>Adding new gems needed for testing often requires changes in RSpec configuration. You add a new line of config here and there in the <code class="language-plaintext highlighter-rouge">spec_helper.rb</code> or <code class="language-plaintext highlighter-rouge">rails_helper.rb</code> file and suddenly you have huge and hard to understand config file for RSpec.</p>

<p>I will show you how I organize my RSpec configuration directory structure to easily add or modify the RSpec configuration in a clean way.</p>

<h2 id="prepare-rspec-config-directory-structure">Prepare RSpec config directory structure</h2>

<p>I keep all of my configuration code related to RSpec in directory <code class="language-plaintext highlighter-rouge">spec/support/config</code>. You can create it.</p>

<p>Next step is to ensure the RSpec will read files from the config directory. In order to do it please ensure you have below line in your <code class="language-plaintext highlighter-rouge">spec/rails_helper.rb</code> file.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Dir</span><span class="p">[</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s1">'spec/support/**/*.rb'</span><span class="p">)].</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="nb">require</span> <span class="n">f</span> <span class="p">}</span></code></pre></figure>

<p>By default, it is commented out so please uncomment it.</p>

<h2 id="separate-config-files-for-different-testing-gems">Separate config files for different testing gems</h2>

<p>Here I will show you examples of popular gems and how to keep their configuration clean. A few examples are on the video and many more code examples are in this article.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/M0-ZQkYoQmI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<h2 id="configuration-for-database-cleaner">Configuration for Database Cleaner</h2>

<p>For <a href="https://github.com/DatabaseCleaner/database_cleaner">database_cleaner</a> gem you can just create config file <code class="language-plaintext highlighter-rouge">spec/support/config/database_cleaner.rb</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/support/config/database_cleaner.rb</span>
<span class="nb">require</span> <span class="s1">'database_cleaner'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">before</span><span class="p">(</span><span class="ss">:suite</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">DatabaseCleaner</span><span class="p">.</span><span class="nf">strategy</span> <span class="o">=</span> <span class="ss">:deletion</span>
    <span class="no">DatabaseCleaner</span><span class="p">.</span><span class="nf">clean_with</span><span class="p">(</span><span class="ss">:deletion</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">around</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">example</span><span class="o">|</span>
    <span class="no">DatabaseCleaner</span><span class="p">.</span><span class="nf">cleaning</span> <span class="k">do</span>
      <span class="n">example</span><span class="p">.</span><span class="nf">run</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h2 id="configuration-for-capybara">Configuration for Capybara</h2>

<p>Here is my configuration of Capybara placed at <code class="language-plaintext highlighter-rouge">spec/support/config/capybara.rb</code>.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/support/config/capybara.rb</span>
<span class="nb">require</span> <span class="s1">'capybara/rspec'</span>

<span class="no">JS_DRIVER</span> <span class="o">=</span> <span class="ss">:selenium_chrome_headless</span>
<span class="no">DEFAULT_MAX_WAIT_TIME</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s1">'CI'</span><span class="p">]</span> <span class="p">?</span> <span class="mi">5</span> <span class="p">:</span> <span class="mi">2</span>

<span class="no">Capybara</span><span class="p">.</span><span class="nf">default_driver</span> <span class="o">=</span> <span class="ss">:rack_test</span>
<span class="no">Capybara</span><span class="p">.</span><span class="nf">javascript_driver</span> <span class="o">=</span> <span class="no">JS_DRIVER</span>
<span class="no">Capybara</span><span class="p">.</span><span class="nf">default_max_wait_time</span> <span class="o">=</span> <span class="no">DEFAULT_MAX_WAIT_TIME</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">example</span><span class="o">|</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">current_driver</span> <span class="o">=</span> <span class="no">JS_DRIVER</span> <span class="k">if</span> <span class="n">example</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="ss">:js</span><span class="p">]</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">current_driver</span> <span class="o">=</span> <span class="ss">:selenium</span> <span class="k">if</span> <span class="n">example</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="ss">:selenium</span><span class="p">]</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">current_driver</span> <span class="o">=</span> <span class="ss">:selenium_chrome</span> <span class="k">if</span> <span class="n">example</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="ss">:selenium_chrome</span><span class="p">]</span>

    <span class="no">Capybara</span><span class="p">.</span><span class="nf">default_max_wait_time</span> <span class="o">=</span> <span class="n">example</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="ss">:max_wait_time</span><span class="p">]</span> <span class="k">if</span> <span class="n">example</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="ss">:max_wait_time</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">after</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">example</span><span class="o">|</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">use_default_driver</span> <span class="k">if</span> <span class="n">example</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="ss">:js</span><span class="p">]</span> <span class="o">||</span> <span class="n">example</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="ss">:selenium</span><span class="p">]</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">default_max_wait_time</span> <span class="o">=</span> <span class="no">DEFAULT_MAX_WAIT_TIME</span> <span class="k">if</span> <span class="n">example</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="ss">:max_wait_time</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>I have a few custom things here like easy option to switch between different browsers executing my tests by just adding tag like <code class="language-plaintext highlighter-rouge">:selenium_chrome</code> to test:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/features/example_feature_spec.rb</span>
<span class="n">it</span> <span class="s1">'something'</span><span class="p">,</span> <span class="ss">:selenium_chrome</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="s1">'/'</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span> <span class="s1">'Welcome'</span>
<span class="k">end</span></code></pre></figure>

<p>You can learn more <a href="/2017/circleci-2-0-capybara-feature-specs-selenium-webdriver-with-chrome-headless">how to configure Capybara with Chrome headless</a> here.</p>

<h2 id="configuration-for-sidekiq">Configuration for Sidekiq</h2>

<p>I like keep my Sidekiq configuration with other useful Sidekiq related gems in one place <code class="language-plaintext highlighter-rouge">spec/support/config/sidekiq.rb</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/support/config/sidekiq.rb</span>
<span class="nb">require</span> <span class="s1">'rspec-sidekiq'</span>
<span class="nb">require</span> <span class="s1">'sidekiq/testing'</span>
<span class="nb">require</span> <span class="s1">'sidekiq_unique_jobs/testing'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Worker</span><span class="p">.</span><span class="nf">clear_all</span>

    <span class="c1"># https://github.com/mperham/sidekiq/wiki/Testing#testing-worker-queueing-fake</span>
    <span class="k">if</span> <span class="no">RSpec</span><span class="p">.</span><span class="nf">current_example</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="ss">:sidekiq_fake</span><span class="p">]</span>
      <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Testing</span><span class="p">.</span><span class="nf">fake!</span>
    <span class="k">end</span>

    <span class="c1"># https://github.com/mperham/sidekiq/wiki/Testing#testing-workers-inline</span>
    <span class="k">if</span> <span class="no">RSpec</span><span class="p">.</span><span class="nf">current_example</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="ss">:sidekiq_inline</span><span class="p">]</span>
      <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Testing</span><span class="p">.</span><span class="nf">inline!</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">config</span><span class="p">.</span><span class="nf">after</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">if</span> <span class="no">RSpec</span><span class="p">.</span><span class="nf">current_example</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="ss">:sidekiq_fake</span><span class="p">]</span> <span class="o">||</span> <span class="no">RSpec</span><span class="p">.</span><span class="nf">current_example</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="ss">:sidekiq_inline</span><span class="p">]</span>
      <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Testing</span><span class="p">.</span><span class="nf">disable!</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">RSpec</span><span class="o">::</span><span class="no">Sidekiq</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">warn_when_jobs_not_processed_by_sidekiq</span> <span class="o">=</span> <span class="kp">false</span>
<span class="k">end</span></code></pre></figure>

<p>I use gems like <a href="https://github.com/mhenrixon/sidekiq-unique-jobs">sidekiq-unique-jobs</a> and <a href="https://github.com/philostler/rspec-sidekiq">rspec-sidekiq</a>. Here you can read more about <a href="https://github.com/mperham/sidekiq/wiki/Testing">Sidekiq testing</a> configuration.</p>

<h2 id="configuration-for-factorybot-known-as-factorygirl">Configuration for FactoryBot (known as FactoryGirl)</h2>

<p><a href="https://github.com/thoughtbot/factory_bot_rails">FactoryBot</a> config file for Ruby on Rails can be isolated at <code class="language-plaintext highlighter-rouge">spec/support/config/factory_bot.rb</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/support/config/factory_bot.rb</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">include</span> <span class="no">FactoryBot</span><span class="o">::</span><span class="no">Syntax</span><span class="o">::</span><span class="no">Methods</span>
<span class="k">end</span></code></pre></figure>

<h2 id="configuration-for-json-spec">Configuration for JSON Spec</h2>

<p>If you have API endpoints in your application you may like the <a href="https://github.com/collectiveidea/json_spec">json_spec</a> gem that can help you test JSON responses. Here is my config at <code class="language-plaintext highlighter-rouge">spec/support/config/json_spec.rb</code></p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/support/config/json_spec.rb</span>
<span class="nb">require</span> <span class="s1">'json_spec'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">include</span> <span class="no">JsonSpec</span><span class="o">::</span><span class="no">Helpers</span>
<span class="k">end</span></code></pre></figure>

<h2 id="configuration-for-rspec-retry">Configuration for RSpec Retry</h2>

<p>Sometimes big projects have painful tests that randomly fail. The last rescue when we cannot make them stable and always green is to retry them a few times before marking them as failed. This is one option how to deal with flaky tests and we can use for that <a href="https://github.com/NoRedInk/rspec-retry">rspec-retry</a> gem.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/support/config/rspec_retry.rb</span>
<span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="c1"># show retry status in spec process</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">verbose_retry</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="c1"># show exception that triggers a retry if verbose_retry is set to true</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">display_try_failure_messages</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="c1"># run retry only on features</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">around</span> <span class="ss">:each</span><span class="p">,</span> <span class="ss">:js</span> <span class="k">do</span> <span class="o">|</span><span class="n">ex</span><span class="o">|</span>
    <span class="c1"># retry test 3 times on CI but do not retry when testing locally</span>
    <span class="n">ex</span><span class="p">.</span><span class="nf">run_with_retry</span> <span class="ss">retry: </span><span class="p">(</span><span class="no">ENV</span><span class="p">[</span><span class="s1">'CI'</span><span class="p">]</span> <span class="p">?</span> <span class="mi">3</span> <span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># callback to be run between retries</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">retry_callback</span> <span class="o">=</span> <span class="nb">proc</span> <span class="k">do</span> <span class="o">|</span><span class="n">ex</span><span class="o">|</span>
    <span class="c1"># run some additional clean up task - can be filtered by example metadata</span>
    <span class="k">if</span> <span class="n">ex</span><span class="p">.</span><span class="nf">metadata</span><span class="p">[</span><span class="ss">:js</span><span class="p">]</span>
      <span class="no">Capybara</span><span class="p">.</span><span class="nf">reset!</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Here you can learn more about how to deal with flaky tests:</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/Cg6GpEYfO9s" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<h2 id="configuration-for-shoulda-matchers">Configuration for Shoulda Matchers</h2>

<p><a href="https://github.com/thoughtbot/shoulda-matchers">Shoulda Matchers</a> provides RSpec and Minitest-compatible one-liners that test common Rails functionality. Here is my config <code class="language-plaintext highlighter-rouge">spec/support/config/shoulda_matchers.rb</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/support/config/shoulda_matchers.rb</span>
<span class="nb">require</span> <span class="s1">'shoulda/matchers'</span>

<span class="no">Shoulda</span><span class="o">::</span><span class="no">Matchers</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">integrate</span> <span class="k">do</span> <span class="o">|</span><span class="n">with</span><span class="o">|</span>
    <span class="c1"># Choose a test framework:</span>
    <span class="n">with</span><span class="p">.</span><span class="nf">test_framework</span> <span class="ss">:rspec</span>
    <span class="c1">#with.test_framework :minitest</span>
    <span class="c1">#with.test_framework :minitest_4</span>
    <span class="c1">#with.test_framework :test_unit</span>

    <span class="c1"># Choose one or more libraries:</span>
    <span class="c1">#with.library :active_record</span>
    <span class="c1">#with.library :active_model</span>
    <span class="c1">#with.library :action_controller</span>
    <span class="c1"># Or, choose the following (which implies all of the above):</span>
    <span class="n">with</span><span class="p">.</span><span class="nf">library</span> <span class="ss">:rails</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<h2 id="configuration-for-vcr-and-webmock">Configuration for VCR and WebMock</h2>

<p>You can record your requests in testing with <a href="https://github.com/vcr/vcr">VCR</a> or mock request with <a href="https://github.com/bblimke/webmock">WebMock</a>. This is my config <code class="language-plaintext highlighter-rouge">spec/support/config/vcr.rb</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/support/config/vcr.rb</span>
<span class="nb">require</span> <span class="s1">'vcr'</span>

<span class="no">VCR</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">cassette_library_dir</span> <span class="o">=</span> <span class="s1">'spec/fixtures/vcr_cassettes'</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">hook_into</span> <span class="ss">:webmock</span> <span class="c1"># or :fakeweb</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">allow_http_connections_when_no_cassette</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">ignore_hosts</span><span class="p">(</span>
    <span class="s1">'localhost'</span><span class="p">,</span>
    <span class="s1">'127.0.0.1'</span><span class="p">,</span>
    <span class="s1">'0.0.0.0'</span><span class="p">,</span>
    <span class="s1">'example.com'</span><span class="p">,</span>
  <span class="p">)</span>
<span class="k">end</span>

<span class="no">WebMock</span><span class="p">.</span><span class="nf">disable_net_connect!</span><span class="p">(</span><span class="ss">allow: </span><span class="p">[</span>
  <span class="s1">'example.com'</span><span class="p">,</span>
<span class="p">])</span></code></pre></figure>

<h2 id="configuration-for-knapsack-pro-to-split-test-suite-across-parallel-ci-nodes">Configuration for Knapsack Pro to split test suite across parallel CI nodes</h2>

<p>If you have a large test suite taking a dozen of minutes or maybe even hours then you may want to <a href="http://knapsackpro.com?utm_source=docs_knapsackpro&amp;utm_medium=blog_post&amp;utm_campaign=clean-rspec-configuration-directory-structure-for-ruby-on-rails-gems-needed-in-testing">run tests in parallel across multiple CI node with Knapsack Pro</a> to get the fastest CI build.</p>

<p>This is example config file.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/support/config/knapsack_pro.rb</span>
<span class="nb">require</span> <span class="s1">'knapsack_pro'</span>
<span class="no">KnapsackPro</span><span class="o">::</span><span class="no">Adapters</span><span class="o">::</span><span class="no">RSpecAdapter</span><span class="p">.</span><span class="nf">bind</span></code></pre></figure>

<p>Here you can learn more about how it works.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/rF5dokNqsMA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe>

<h2 id="configuration-for-page-objects">Configuration for Page Objects</h2>

<p>You can keep your page objects in a separate directory. Page objects can be later reused in multiple tests.
Create directory <code class="language-plaintext highlighter-rouge">spec/support/page_objects</code>. Here is example page object for billing page:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/support/page_objects/billing_page.rb</span>
<span class="k">class</span> <span class="nc">BillingPage</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">fill_company_details</span><span class="p">(</span>
    <span class="ss">first_name: </span><span class="s1">'Kayleigh'</span><span class="p">,</span>
    <span class="ss">last_name: </span><span class="s1">'Johnston'</span><span class="p">,</span>
    <span class="ss">company: </span><span class="s1">'Example Company'</span><span class="p">,</span>
    <span class="ss">vat_id: </span><span class="s1">'UK1234567890'</span><span class="p">,</span>
    <span class="ss">email: </span><span class="s1">'kayleigh.johnston@example.com'</span><span class="p">,</span>
    <span class="ss">street_address: </span><span class="s1">'59 Botley Road'</span><span class="p">,</span>
    <span class="ss">locality: </span><span class="s1">'Midtown'</span><span class="p">,</span>
    <span class="ss">region: </span><span class="s1">''</span><span class="p">,</span> <span class="c1"># can be blank</span>
    <span class="ss">postal_code: </span><span class="s1">'IV27 5LL'</span><span class="p">,</span>
    <span class="ss">country_name: </span><span class="s1">'United Kingdom'</span><span class="p">,</span>
    <span class="ss">website: </span><span class="s1">'http://example.com'</span>
  <span class="p">)</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">fill_in</span> <span class="s1">'first_name'</span><span class="p">,</span> <span class="ss">with: </span><span class="n">first_name</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">fill_in</span> <span class="s1">'last_name'</span><span class="p">,</span> <span class="ss">with: </span><span class="n">last_name</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">fill_in</span> <span class="s1">'company'</span><span class="p">,</span> <span class="ss">with: </span><span class="n">company</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">fill_in</span> <span class="s1">'vat_id'</span><span class="p">,</span> <span class="ss">with: </span><span class="n">vat_id</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">fill_in</span> <span class="s1">'email'</span><span class="p">,</span> <span class="ss">with: </span><span class="n">email</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">fill_in</span> <span class="s1">'street_address'</span><span class="p">,</span> <span class="ss">with: </span><span class="n">street_address</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">fill_in</span> <span class="s1">'locality'</span><span class="p">,</span> <span class="ss">with: </span><span class="n">locality</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">fill_in</span> <span class="s1">'region'</span><span class="p">,</span> <span class="ss">with: </span><span class="n">region</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">fill_in</span> <span class="s1">'postal_code'</span><span class="p">,</span> <span class="ss">with: </span><span class="n">postal_code</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">select</span> <span class="n">country_name</span><span class="p">,</span> <span class="ss">from: </span><span class="s1">'country_name'</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">fill_in</span> <span class="s1">'website'</span><span class="p">,</span> <span class="ss">with: </span><span class="n">website</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Then you can use the page object in your feature spec.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># spec/features/billing_spec.rb</span>
<span class="n">it</span> <span class="s1">'fills company details on billing page'</span> <span class="k">do</span>
  <span class="no">BillingPage</span><span class="p">.</span><span class="nf">fill_company_details</span>
<span class="k">end</span></code></pre></figure>

<h2 id="configuration-for-shared-examples">Configuration for shared examples</h2>

<p>You can organize your <a href="https://relishapp.com/rspec/rspec-core/docs/example-groups/shared-examples">RSpec shared examples</a> in directory <code class="language-plaintext highlighter-rouge">spec/support/shared_examples</code> that will be autoloaded.</p>

<h2 id="summary">Summary</h2>

<p>As you can see there are a lot of different useful gems for testing in RSpec. If we would keep all their configuration just in <code class="language-plaintext highlighter-rouge">spec_helper.rb</code> we would quickly get a messy file. Separation of config files can help us keep it clean and easy to maintain. Let me know in comments how you keep your config files sane.</p>

  </div>

  <div class="share-post-container">
  <div class="share-post-left">
    <div class="fb-share-button" data-href="https://docs.knapsackpro.com/2018/clean-rspec-configuration-directory-structure-for-ruby-on-rails-gems-needed-in-testing" data-layout="button_count" data-mobile-iframe="true"></div>

    <a href="https://twitter.com/share" class="twitter-share-button" data-via="KnapsackPro" data-hashtags="">Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  </div>

  <div class="share-post-right">
    <a href="https://twitter.com/KnapsackPro" class="twitter-follow-button" data-show-count="false" data-show-screen-name="false">Follow @KnapsackPro</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  </div>
</div>


  
<div class="wrapper">
<div class="author-container">
  <img src="//gravatar.com/avatar/e3be50760a95eebc47c7f239b3ad3ede.png" class="rounded-circle author-img" alt="Artur Trzop" />
  <div class="author-info">
    <p>
    Written by <strong>Artur Trzop</strong>
    </p>
    <p>
    Let's connect on <i class="fab fa-linkedin linkedin-color"></i> <a href="https://www.linkedin.com/in/arturtrzop/" rel="nofollow noopener" target="_blank" class="page-link">LinkedIn</a> or see my <i class="fab fa-youtube youtube-color"></i> <a href="https://www.youtube.com/c/ArturTrzop" rel="nofollow noopener" target="_blank" class="page-link">YouTube</a>
    </p>
    <p>
    Founder of Knapsack Pro, follow on <i class="fab fa-twitter twitter-color"></i> <a href="https://twitter.com/ArturTrzop" rel="nofollow noopener" target="_blank" class="page-link">Twitter</a>
    </p>
  </div>
</div>
</div>



  <div>
  <div id="disqus_thread"></div>
  <script>
  /**
  * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
  * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
  */
  /*
  var disqus_config = function () {
  this.page.url = "https://docs.knapsackpro.com/2018/clean-rspec-configuration-directory-structure-for-ruby-on-rails-gems-needed-in-testing"; // Replace PAGE_URL with your page's canonical URL variable
  this.page.identifier = "https://docs.knapsackpro.com/2018/clean-rspec-configuration-directory-structure-for-ruby-on-rails-gems-needed-in-testing"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
  };
  */
  (function() { // DON'T EDIT BELOW THIS LINE
  var d = document, s = d.createElement('script');

  s.src = '//knapsackpro.disqus.com/embed.js';

  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>


</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Blog about testing & documentation for KnapsackPro.com</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Found a typo? Want to contribute?</li>
          <li><a href="https://github.com/KnapsackPro/docs.knapsackpro.com">Source Code of this site</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          <li><i class="fab fa-youtube"></i> <a href="https://www.youtube.com/c/ArturTrzop" rel="nofollow noopener" target="_blank" class="page-link">Testing tips</a></li>
          <li><i class="fab fa-twitter"></i> <a href="https://twitter.com/KnapsackPro" rel="nofollow noopener" target="_blank" class="page-link">Follow us on Twitter</a></li>
          <li><i class="fab fa-facebook-square"></i> <a href="https://www.facebook.com/KnapsackPro" rel="nofollow noopener" target="_blank" class="page-link">Like our Fanpage</a></li>
          <li><i class="fab fa-linkedin"></i> <a href="https://www.linkedin.com/company/knapsackpro/" rel="nofollow noopener" target="_blank" class="page-link">Follow us on LinkedIn</a></li>
          <li><i class="fab fa-github"></i> <a href="https://github.com/KnapsackPro" rel="nofollow noopener" target="_blank" class="page-link">GitHub</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p class="text">Speed up your tests with optimal test suite parallelisation on your CI. Blog & documentation for Knapsack Pro.</p>
      </div>
    </div>

    <div class="footer-copy">
      &copy; 2015 - 2022 <a href="https://knapsackpro.com">KnapsackPro.com</a>
    </div>

  </div>

</footer>

    <style>
  #js-cookies-message{padding: 0.5rem 1rem; display: none; opacity: 90%; text-align: center; position: fixed; bottom: 0; width: calc(100% - 2rem); background: #efefef;}
  #js-cookies-message button {cursor: pointer; border-radius: 10px; padding: 10px 20px; background-color: #0864cf; color: #fff; border: 0;}
  #js-cookies-message button:hover {background-color: #5e8fc8;}
</style>

<div id="js-cookies-message">
  <p>
    This site uses cookies. By staying here you accept them. See our <a href="https://knapsackpro.com/cookies", target="_blank">Cookie Policy</a> for details.<br>
    For more information on how to turn off the use of cookies, please <a href="https://knapsackpro.com/cookies#turning-off-cookies", target="_blank">see this</a>.<br>
    To refuse the use of cookies, please leave the page (more details <a href="https://knapsackpro.com/cookies#withdrawing-consent", target="_blank">here</a>).
  </p>
  <p>
    <a href="#" class="btn btn-primary" id="js-cookies-close"><button>I Agree</button></a>
  </p>
</div>

<script>
  $(document).ready(function() {
    var cookieName = 'cookies_consent_docs'

    if (document.cookie.includes(cookieName)) {
      // no-op
    } else {
      document.getElementById('js-cookies-message').style.display = 'block';
    };

    $("#js-cookies-close").click(function(e) {
      e.preventDefault()

      $("#js-cookies-message").fadeOut()

      var date = new Date();
      date.setMonth(date.getMonth() + 12);
      var dateString = date.toUTCString();

      document.cookie = cookieName + "=true;expires=" + dateString + ";path=/"

      gtag('event', 'Cookie consent - I agree', {});
    });
  });
</script>

  </body>

</html>
