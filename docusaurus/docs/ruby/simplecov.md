---
pagination_next: null
pagination_prev: null
---

import { TOCBottom } from '@site/src/components/TOCBottom'
import { IconExternalLink } from '@site/src/components/IconExternalLink'

<TOCBottom heading="Reference" Icon={<IconExternalLink />}>

- [Using Knapsack Pro with CodeClimate](code-climate.md)

</TOCBottom>

# Using Knapsack Pro in Queue Mode with SimpleCov

:::caution

This is needed only if you are using Knapsack Pro in [Queue Mode](../overview/index.mdx#queue-mode-dynamic-split).

:::

## RSpec

Apply the following code:

```ruby title="spec/spec_helper.rb"
require 'knapsack_pro'
require 'simplecov'

SimpleCov.start

# highlight-start
KnapsackPro::Hooks::Queue.before_queue do |queue_id|
  SimpleCov.command_name("rspec_ci_node_#{KnapsackPro::Config::Env.ci_node_index}")
end
# highlight-end
```

This is needed to avoid conflicts between code coverage reports generated by parallel CI nodes.

If the local drive is common between parallel nodes on your CI, `simplecov` will generate a single report at `coverage/index.html` with merged data. Otherwise, you can refer to [How to merge CodeClimate reports for parallel jobs (CI nodes)](https://docs.knapsackpro.com/2019/how-to-merge-codeclimate-reports-for-parallel-jobs-ci-nodes) or [How to merge SimpleCov results with parallel Rails specs on Semaphore CI](https://docs.knapsackpro.com/2020/how-to-merge-simplecov-results-with-parallel-rails-specs).

Please [see this if you use CodeClimate](code-climate.md).

## Minitest

Apply the following code:

```ruby title="test/test_helper.rb"
require 'knapsack_pro'
require 'simplecov'

SimpleCov.start

# highlight-start
KnapsackPro::Hooks::Queue.before_queue do |queue_id|
  SimpleCov.command_name("minitest_ci_node_#{KnapsackPro::Config::Env.ci_node_index}")
end

KnapsackPro::Hooks::Queue.after_queue do
  SimpleCov.result.format!
end
# highlight-end
```

This is needed to avoid conflicts between code coverage reports generated by parallel CI nodes.

<details>
  <summary>For legacy versions of `knapsack_pro` older than 6.0.4, please click here.</summary>

  ```ruby title="test/test_helper.rb"
  require 'knapsack_pro'
  require 'simplecov'

  SimpleCov.start

  # highlight-start
  KnapsackPro::Hooks::Queue.before_queue do |queue_id|
    SimpleCov.command_name("minitest_ci_node_#{KnapsackPro::Config::Env.ci_node_index}")
  end
  # highlight-end
  ```

</details>

