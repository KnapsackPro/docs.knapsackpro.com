---
pagination_next: null
pagination_prev: null
---

import { TOCBottom } from '@site/src/components/TOCBottom'
import { IconExternalLink } from '@site/src/components/IconExternalLink'

<TOCBottom heading="Reference" Icon={<IconExternalLink />}>

- [Using Knapsack Pro with CodeClimate](code-climate.md)

</TOCBottom>

# Using Knapsack Pro in Queue Mode with SimpleCov

:::caution

This is needed only if you are using Knapsack Pro in [Queue Mode](../overview/index.mdx#queue-mode-dynamic-split).

:::

## RSpec

Apply the following code:

```ruby title="spec/spec_helper.rb"
require 'knapsack_pro'
require 'simplecov'

SimpleCov.start

# highlight-start
KnapsackPro::Hooks::Queue.before_queue do |queue_id|
  SimpleCov.command_name("rspec_ci_node_#{KnapsackPro::Config::Env.ci_node_index}")
end
# highlight-end
```

This is needed to avoid conflicts between code coverage reports generated by parallel CI nodes.

Please [see this if you use CodeClimate](code-climate.md#rspec).

## Minitest

Apply the following code:

```ruby title="test/test_helper.rb"
require 'knapsack_pro'
require 'simplecov'

SimpleCov.start

# highlight-start
KnapsackPro::Hooks::Queue.before_queue do |queue_id|
  SimpleCov.command_name("minitest_ci_node_#{KnapsackPro::Config::Env.ci_node_index}")
end

KnapsackPro::Hooks::Queue.after_queue do
  SimpleCov.result.format!
end
# highlight-end
```

This is needed to avoid conflicts between code coverage reports generated by parallel CI nodes.

Please [see this if you use CodeClimate](code-climate.md#minitest).

<details>
  <summary>For legacy versions of `knapsack_pro` older than 6.0.4, please click here.</summary>

  ```ruby title="test/test_helper.rb"
  require 'knapsack_pro'
  require 'simplecov'

  SimpleCov.start

  # highlight-start
  KnapsackPro::Hooks::Queue.before_queue do |queue_id|
    SimpleCov.command_name("minitest_ci_node_#{KnapsackPro::Config::Env.ci_node_index}")
  end
  # highlight-end
  ```

</details>

## How to merge SimpleCov reports from parallel CI nodes

### Isolated parallel nodes with their own disk

Please check SimpleCov docs for [merging test runs under different execution environments](https://github.com/simplecov-ruby/simplecov?tab=readme-ov-file#merging-test-runs-under-different-execution-environments).

You could create [a rake task to merge SimpleCov reports](https://github.com/simplecov-ruby/simplecov/issues/986#issuecomment-1164999210).

Please refer to your CI provider documentation to learn how to get files from parallel nodes and put them in the same location so that you can merge them.
You can also look at these examples:

* [How to merge SimpleCov results with parallel Rails specs on Semaphore CI](https://docs.knapsackpro.com/2020/how-to-merge-simplecov-results-with-parallel-rails-specs)
* [How to merge CodeClimate reports for parallel jobs (CI nodes)](https://docs.knapsackpro.com/2019/how-to-merge-codeclimate-reports-for-parallel-jobs-ci-nodes)

### Shared disk between parallel nodes

SimpleCov generates a single report at `coverage/index.html` with merged data if a local drive is shared between parallel nodes. This is the case when you use Jenkins and the disk is shared between parallel nodes.
