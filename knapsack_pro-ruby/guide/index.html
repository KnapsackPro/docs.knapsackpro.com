<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Installation guide for ruby gem knapsack_pro</title>
  <meta name="description" content="Speed up your tests with optimal test suite parallelisation on your CI. Blog & documentation for Knapsack Pro.">

  <meta property="og:title" content="Installation guide for ruby gem knapsack_pro">
  <meta name="twitter:title" content="Installation guide for ruby gem knapsack_pro">
  <meta name="twitter:description" content="Speed up your tests with optimal test suite parallelisation on your CI. Blog & documentation for Knapsack Pro.">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@KnapsackPro">

  

  <link rel="shortcut icon" href="/images/favicon.ico" />
  <link rel="stylesheet" href="/css/main.css?version=1">
  <link rel="canonical" href="https://docs.knapsackpro.com/knapsack_pro-ruby/guide/">
  <link rel="alternate" type="application/rss+xml" title="Blog about testing & documentation for KnapsackPro.com" href="https://docs.knapsackpro.com/feed.xml" />
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:100,200,300,400,600,700&amp;subset=latin,latin-ext" type="text/css" rel="stylesheet" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
</head>


  <body>

    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JPGP34N3JJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JPGP34N3JJ');
</script>


    <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.6";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1803263473334711'); // Insert your pixel ID here.
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1803263473334711&ev=PageView&noscript=1"
/></noscript>
<!-- DO NOT MODIFY -->
<!-- End Facebook Pixel Code -->


    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://knapsackpro.com/">
      <img src="/images/logo.png" alt="Knapsack Pro Documentation" width="32" height="32">
      Knapsack Pro&nbsp;
    </a>
    <a class="site-title" href="/">
      <strong>Docs</strong>
    </a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a href="https://www.youtube.com/c/ArturTrzop" rel="nofollow noopener" target="_blank" class="page-link"><i class="fab fa-youtube"></i></a>
        <a href="https://twitter.com/KnapsackPro" rel="nofollow noopener" target="_blank" class="page-link"><i class="fab fa-twitter"></i></a>
        <a href="https://www.facebook.com/KnapsackPro" rel="nofollow noopener" target="_blank" class="page-link"><i class="fab fa-facebook-square"></i></a>
        <a href="https://www.linkedin.com/company/knapsackpro/" rel="nofollow noopener" target="_blank" class="page-link"><i class="fab fa-linkedin"></i></a>
        <a href="https://github.com/KnapsackPro" rel="nofollow noopener" target="_blank" class="page-link"><i class="fab fa-github"></i></a>
        <a class="page-link" href="/">Blog</a>
        <a class="page-link" href="/integration/">Get started with integration</a>
        <a class="page-link" href="/api/">API</a>
        <a class="page-link" href="https://knapsackpro.com">Sign up</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Installation guide for ruby gem knapsack_pro</h1>
  </header>

  <article class="post-content">
    <script src="/javascripts/knapsack_pro-ruby/guide.js?version=1"></script>

<p>You can find more detailed information and configuration options in the <a href="https://github.com/KnapsackPro/knapsack_pro-ruby">README for the knapsack_pro gem</a>.<br />
<a href="http://knapsackpro.com?utm_source=docs_knapsackpro&amp;utm_medium=page&amp;utm_campaign=knapsack_pro-ruby_gem&amp;utm_content=installation_guide">Create an account at Knapsack Pro to use the knapsack_pro gem</a></p>

<h2 id="installation">Installation</h2>

<p>Add the following code to your application’s <code class="language-plaintext highlighter-rouge">Gemfile</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">group</span> <span class="ss">:test</span><span class="p">,</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'knapsack_pro'</span>
<span class="k">end</span></code></pre></figure>

<p>And then execute:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">bundle <span class="nb">install</span></code></pre></figure>

<p>If you are not using Rails, then add this line at the bottom of your <code class="language-plaintext highlighter-rouge">Rakefile</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># Only needed if you are not using Rails.</span>
<span class="no">KnapsackPro</span><span class="p">.</span><span class="nf">load_tasks</span> <span class="k">if</span> <span class="k">defined?</span><span class="p">(</span><span class="no">KnapsackPro</span><span class="p">)</span></code></pre></figure>

<h2 id="questions">Questions</h2>

<p>Please answer the following questions to get the basic <code class="language-plaintext highlighter-rouge">knapsack_pro</code> configuration for your project.</p>

<p>
  <strong>Choose your testing tools:</strong>
  <ul class="none-list">
    <li><label><input type="checkbox" id="test-runner-rspec" /> RSpec</label></li>
    <li><label><input type="checkbox" id="test-runner-cucumber" /> Cucumber</label></li>
    <li><label><input type="checkbox" id="test-runner-minitest" /> Minitest</label></li>
    <li><label><input type="checkbox" id="test-runner-spinach" /> Spinach</label></li>
    <li><label><input type="checkbox" id="test-runner-test-unit" /> test-unit</label></li>
  </ul>
</p>

<p>
  <strong>Do you use VCR, WebMock, or FakeWeb gem?</strong><br />
  <label><input type="checkbox" id="vcr-webmock-fakeweb" /> Yes</label>
</p>

<p>
  <strong>What is your CI provider?</strong>
  <ul class="none-list">
    <li><label><input type="radio" name="ci-provider" value="appveyor" /> AppVeyor</label></li>
    <li><label><input type="radio" name="ci-provider" value="buildkite" /> Buildkite</label></li>
    <li><label><input type="radio" name="ci-provider" value="circleci" /> CircleCI</label></li>
    <li><label><input type="radio" name="ci-provider" value="cirrus-ci" /> Cirrus CI</label></li>
    <li><label><input type="radio" name="ci-provider" value="codeship" /> CloudBees CodeShip</label></li>
    <li><label><input type="radio" name="ci-provider" value="codefresh" /> Codefresh</label></li>
    <li><label><input type="radio" name="ci-provider" value="github-actions" /> GitHub Actions</label></li>
    <li><label><input type="radio" name="ci-provider" value="gitlab-ci" /> GitLab CI</label></li>
    <li><label><input type="radio" name="ci-provider" value="heroku-ci" /> Heroku CI</label></li>
    <li><label><input type="radio" name="ci-provider" value="jenkins" /> Jenkins</label></li>
    <li><label><input type="radio" name="ci-provider" value="semaphoreci" /> Semaphore CI</label></li>
    <li><label><input type="radio" name="ci-provider" value="travis-ci" /> Travis CI</label></li>
    <li><label><input type="radio" name="ci-provider" value="other" /> other</label></li>
  </ul>
</p>

<div id="guide-test-runner-rspec" class="hidden">
  <h3>Step for RSpec</h3>

  <p>
    Add the following code at the beginning of your <code class="language-plaintext highlighter-rouge">spec/rails_helper.rb</code> or <code class="language-plaintext highlighter-rouge">spec/spec_helper.rb</code>:
  </p>


<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'knapsack_pro'</span>
<span class="no">KnapsackPro</span><span class="o">::</span><span class="no">Adapters</span><span class="o">::</span><span class="no">RSpecAdapter</span><span class="p">.</span><span class="nf">bind</span></code></pre></figure>

</div>

<div id="guide-test-runner-minitest" class="hidden">
  <h3>Step for Minitest</h3>

  <p>
    Add the Knapsack Pro code after you load the app environment in the <code class="language-plaintext highlighter-rouge">test/test_helper.rb</code> file:
  </p>


<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">ENV</span><span class="p">[</span><span class="s1">'RAILS_ENV'</span><span class="p">]</span> <span class="o">||=</span> <span class="s1">'test'</span>
<span class="nb">require</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../../config/environment'</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">)</span>
<span class="nb">require</span> <span class="s1">'rails/test_help'</span>

<span class="nb">require</span> <span class="s1">'knapsack_pro'</span>
<span class="n">knapsack_pro_adapter</span> <span class="o">=</span> <span class="no">KnapsackPro</span><span class="o">::</span><span class="no">Adapters</span><span class="o">::</span><span class="no">MinitestAdapter</span><span class="p">.</span><span class="nf">bind</span>
<span class="n">knapsack_pro_adapter</span><span class="p">.</span><span class="nf">set_test_helper_path</span><span class="p">(</span><span class="kp">__FILE__</span><span class="p">)</span></code></pre></figure>

</div>

<div id="guide-test-runner-test-unit" class="hidden">
  <h3>Step for test-unit</h3>

  <p>
    Add the following code at the beginning of your <code class="language-plaintext highlighter-rouge">test/test_helper.rb</code>:
  </p>


<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'knapsack_pro'</span>
<span class="n">knapsack_pro_adapter</span> <span class="o">=</span> <span class="no">KnapsackPro</span><span class="o">::</span><span class="no">Adapters</span><span class="o">::</span><span class="no">TestUnitAdapter</span><span class="p">.</span><span class="nf">bind</span>
<span class="n">knapsack_pro_adapter</span><span class="p">.</span><span class="nf">set_test_helper_path</span><span class="p">(</span><span class="kp">__FILE__</span><span class="p">)</span></code></pre></figure>

</div>

<div id="guide-test-runner-cucumber" class="hidden">
  <h3>Step for Cucumber</h3>

  <p>
    Create a <code class="language-plaintext highlighter-rouge">features/support/knapsack_pro.rb</code> file with the following code:
  </p>


<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'knapsack_pro'</span>
<span class="no">KnapsackPro</span><span class="o">::</span><span class="no">Adapters</span><span class="o">::</span><span class="no">CucumberAdapter</span><span class="p">.</span><span class="nf">bind</span></code></pre></figure>

</div>

<div id="guide-test-runner-spinach" class="hidden">
  <h3>Step for Spinach</h3>

  <p>
    Create a <code class="language-plaintext highlighter-rouge">features/support/knapsack_pro.rb</code> file with the following code:
  </p>


<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'knapsack_pro'</span>
<span class="no">KnapsackPro</span><span class="o">::</span><span class="no">Adapters</span><span class="o">::</span><span class="no">SpinachAdapter</span><span class="p">.</span><span class="nf">bind</span></code></pre></figure>

</div>

<div id="guide-vcr-webmock-fakeweb" class="hidden">
  <h3>Step for VCR/WebMock/FakeWeb gems</h3>

<p>
  Add Knapsack Pro API subdomain to ignored hosts in <code class="language-plaintext highlighter-rouge">spec/spec_helper.rb</code> (or wherever your VCR configuration is located):
</p>


<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'vcr'</span>
<span class="no">VCR</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">hook_into</span> <span class="ss">:webmock</span> <span class="c1"># or :fakeweb</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">ignore_hosts</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'127.0.0.1'</span><span class="p">,</span> <span class="s1">'0.0.0.0'</span><span class="p">,</span> <span class="s1">'api.knapsackpro.com'</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1"># add the following code if you use webmock:</span>
<span class="nb">require</span> <span class="s1">'webmock/rspec'</span>
<span class="no">WebMock</span><span class="p">.</span><span class="nf">disable_net_connect!</span><span class="p">(</span><span class="ss">allow_localhost: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">allow: </span><span class="p">[</span><span class="s1">'api.knapsackpro.com'</span><span class="p">])</span>

<span class="c1"># add the following code if you use FakeWeb:</span>
<span class="nb">require</span> <span class="s1">'fakeweb'</span>
<span class="no">FakeWeb</span><span class="p">.</span><span class="nf">allow_net_connect</span> <span class="o">=</span> <span class="sr">%r[^https?://api</span><span class="se">\.</span><span class="sr">knapsackpro</span><span class="se">\.</span><span class="sr">com]</span></code></pre></figure>


<p>
  Ensure you have the <code class="language-plaintext highlighter-rouge">require: false</code> setting in Gemfile for the webmock gem when VCR is hooked into it. Thanks to that, the webmock configuration from <code class="language-plaintext highlighter-rouge">spec_helper.rb</code> is loaded properly.
</p>


<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'vcr'</span>
  <span class="n">gem</span> <span class="s1">'webmock'</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span>
  <span class="n">gem</span> <span class="s1">'fakeweb'</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span> <span class="c1"># example when you use fakeweb</span>
<span class="k">end</span></code></pre></figure>


<p>
  If you still happen to see your tests failing due to WebMock not allowing requests to Knapsack Pro API, it probably means that you reconfigure WebMock in some of your tests.
  For instance, you might be using <code class="language-plaintext highlighter-rouge">WebMock.reset!</code>. It might also be called automatically in an <code class="language-plaintext highlighter-rouge">after(:each)</code> block when using <code class="language-plaintext highlighter-rouge">require 'webmock/rspec'</code> (<a href="https://github.com/bblimke/webmock/issues/484#issuecomment-116193449" target="_blank">more about the issue</a>). This would remove <code class="language-plaintext highlighter-rouge">api.knapsackpro.com</code> from the allowed domains. In this case, please try the following:
</p>


<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">RSpec</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">after</span><span class="p">(</span><span class="ss">:suite</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">WebMock</span><span class="p">.</span><span class="nf">disable_net_connect!</span><span class="p">(</span>
      <span class="ss">allow_localhost: </span><span class="kp">true</span><span class="p">,</span>
      <span class="ss">allow: </span><span class="p">[</span>
        <span class="s1">'api.knapsackpro.com'</span><span class="p">,</span>
      <span class="p">],</span>
    <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>


</div>

<div id="guide-providers">
  <div id="guide-provider-circleci" class="hidden">
    <h3>Step for CircleCI</h3>

    <p>
      Example config file for the CircleCI 2.0 platform.
    </p>


<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># CircleCI 2.0</span>
<span class="c1"># .circleci/config.yml</span>
<span class="na">version</span><span class="pi">:</span> <span class="m">2</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">parallelism</span><span class="pi">:</span> <span class="m">2</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">checkout</span>

      <span class="c1"># ... other configs</span>

      <span class="c1"># some tests that are not balanced and executed only on the first CI node</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">case $CIRCLE_NODE_INDEX in 0) npm test ;; esac</span>

      <span class="c1"># auto-balancing CI build execution time (making the whole build as fast as possible).</span>
      <span class="c1"># Queue Mode does dynamic tests allocation, so the previous unbalanced run command won't</span>
      <span class="c1"># create a bottleneck on the CI node</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">RSpec via knapsack_pro Queue Mode</span>
        <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s"># please don't forget the `export` keyword!</span>
          <span class="s">export RAILS_ENV=test</span>
          <span class="s">bundle exec rake "knapsack_pro:queue:rspec[--format documentation]"</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">Minitest via knapsack_pro Queue Mode</span>
        <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s"># please don't forget the `export` keyword!</span>
          <span class="s">export RAILS_ENV=test</span>
          <span class="s">bundle exec rake "knapsack_pro:queue:minitest[--verbose]"</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s">Cucumber via knapsack_pro Queue Mode</span>
        <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s"># please don't forget the `export` keyword!</span>
          <span class="s">export RAILS_ENV=test</span>
          <span class="s"># If you use spring gem and spring-commands-cucumber gem to start Cucumber tests faster, please set</span>
          <span class="s"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bundle exec spring</span>
          <span class="s"># or alternatively you can use spring binstub:</span>
          <span class="s"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bin/spring</span>
          <span class="s"># Thanks to that, Cucumber will start tests faster for each batch of tests fetched from the Knapsack Pro Queue API</span>
          <span class="s">bundle exec rake knapsack_pro:queue:cucumber</span></code></pre></figure>


    <p>
      Adjust the number of parallel containers with the <code class="language-plaintext highlighter-rouge">parallelism</code> attribute.<br />
      Please consult a full example of <a href="/2017/circleci-2-0-capybara-feature-specs-selenium-webdriver-with-chrome-headless" target="_blank">Rails project config on CircleCI 2.0</a> for more details.
    </p>

    <p>
      If you use knapsack_pro Queue Mode with CircleCI, you may want to collect metadata like <a href="https://github.com/KnapsackPro/knapsack_pro-ruby#circleci-and-knapsack_pro-queue-mode" target="_blank">junit xml report about your RSpec</a> test suite with junit formatter. Thanks to that, you can see failed tests in the nice CircleCI web UI. It's also possible to <a href="https://knapsackpro.com/faq/question/how-to-use-junit-formatter" target="_blank">configure junit formatter for knapsack_pro Regular Mode</a>.
    </p>

    <p>
      Please remember to add additional containers for your project in CircleCI settings.
    </p>
  </div>

  <div id="guide-provider-travis-ci" class="hidden">
    <h3>Step for Travis CI</h3>

    <p>
      You can parallelize your builds across virtual machines with the <a href="http://docs.travis-ci.com/user/speeding-up-the-build/#parallelizing-your-builds-across-virtual-machines" target="_blank">travis matrix feature</a>. Edit your config in the <code class="language-plaintext highlighter-rouge">.travis.yml</code> file.
    </p>


<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">script</span><span class="pi">:</span>
  <span class="c1"># Step for RSpec in Regular Mode</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack_pro:rspec"</span>

  <span class="c1"># Step for RSpec in Queue Mode</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack_pro:queue:rspec"</span>

  <span class="c1"># Step for Cucumber in Regular Mode</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack_pro:cucumber"</span>

  <span class="c1"># Step for Cucumber in Queue Mode</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack_pro:queue:cucumber"</span>

  <span class="c1"># Step for Minitest in Regular Mode</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack_pro:minitest"</span>

  <span class="c1"># Step for Minitest in Queue Mode</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack_pro:queue:minitest"</span>

  <span class="c1"># Step for test-unit in Regular Mode</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack_pro:test_unit"</span>

  <span class="c1"># Step for Spinach in Regular Mode</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack_pro:spinach"</span>

<span class="na">env</span><span class="pi">:</span>
  <span class="na">global</span><span class="pi">:</span>
    <span class="c1"># tokens should be set in the Travis settings web interface to avoid exposing tokens in the build logs</span>
    <span class="pi">-</span> <span class="s">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC=rspec-token</span>
    <span class="pi">-</span> <span class="s">KNAPSACK_PRO_TEST_SUITE_TOKEN_CUCUMBER=cucumber-token</span>
    <span class="pi">-</span> <span class="s">KNAPSACK_PRO_TEST_SUITE_TOKEN_MINITEST=minitest-token</span>
    <span class="pi">-</span> <span class="s">KNAPSACK_PRO_TEST_SUITE_TOKEN_TEST_UNIT=test-unit-token</span>
    <span class="pi">-</span> <span class="s">KNAPSACK_PRO_TEST_SUITE_TOKEN_SPINACH=spinach-token</span>

    <span class="c1"># if you use Knapsack Pro Queue Mode, you should set the following env variable to ensure</span>
    <span class="c1"># the correct set of tests is being run when retrying a single failed parallel job from the Travis UI</span>
    <span class="pi">-</span> <span class="s">KNAPSACK_PRO_FIXED_QUEUE_SPLIT=true</span>

    <span class="pi">-</span> <span class="s">KNAPSACK_PRO_CI_NODE_TOTAL=2</span>
  <span class="na">jobs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">KNAPSACK_PRO_CI_NODE_INDEX=0</span>
    <span class="pi">-</span> <span class="s">KNAPSACK_PRO_CI_NODE_INDEX=1</span></code></pre></figure>


    <p>
      This configuration will generate a matrix with the following 2 env rows:
    </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>0 <span class="nv">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</span><span class="o">=</span>rspec-token <span class="nv">KNAPSACK_PRO_TEST_SUITE_TOKEN_CUCUMBER</span><span class="o">=</span>cucumber-token <span class="nv">KNAPSACK_PRO_TEST_SUITE_TOKEN_MINITEST</span><span class="o">=</span>minitest-token <span class="nv">KNAPSACK_PRO_TEST_SUITE_TOKEN_TEST_UNIT</span><span class="o">=</span>test-unit-token <span class="nv">KNAPSACK_PRO_TEST_SUITE_TOKEN_SPINACH</span><span class="o">=</span>spinach-token
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>1 <span class="nv">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</span><span class="o">=</span>rspec-token <span class="nv">KNAPSACK_PRO_TEST_SUITE_TOKEN_CUCUMBER</span><span class="o">=</span>cucumber-token <span class="nv">KNAPSACK_PRO_TEST_SUITE_TOKEN_MINITEST</span><span class="o">=</span>minitest-token <span class="nv">KNAPSACK_PRO_TEST_SUITE_TOKEN_TEST_UNIT</span><span class="o">=</span>test-unit-token <span class="nv">KNAPSACK_PRO_TEST_SUITE_TOKEN_SPINACH</span><span class="o">=</span>spinach-token</code></pre></figure>


    <p>
      You can find more info about global and matrix env configuration in <a href="https://docs.travis-ci.com/user/customizing-the-build/#build-matrix" target="_blank">travis docs</a>.
    </p>
  </div>

  <div id="guide-provider-buildkite" class="hidden">
    <h3>Step for Buildkite</h3>

    <p>
      Knapsack Pro automatically reads the Buildkite ENV variables: <code class="language-plaintext highlighter-rouge">BUILDKITE_PARALLEL_JOB_COUNT</code> and <code class="language-plaintext highlighter-rouge">BUILDKITE_PARALLEL_JOB</code>. The only thing you need to do is to configure the <code class="language-plaintext highlighter-rouge">parallelism</code> parameter in your build step and run the appropriate command in your build:
    </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Step for RSpec</span>
bundle <span class="nb">exec </span>rake knapsack_pro:rspec

<span class="c"># Step for Cucumber</span>
bundle <span class="nb">exec </span>rake knapsack_pro:cucumber

<span class="c"># Step for Minitest</span>
bundle <span class="nb">exec </span>rake knapsack_pro:minitest

<span class="c"># Step for test-unit</span>
bundle <span class="nb">exec </span>rake knapsack_pro:test_unit

<span class="c"># Step for Spinach</span>
bundle <span class="nb">exec </span>rake knapsack_pro:spinach</code></pre></figure>


    <p>
      Please remember to set up your <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code> as a global environment variable.
    </p>

    <p>
      Here you can find an article showing <a href="http://docs.knapsackpro.com/2017/auto-balancing-7-hours-tests-between-100-parallel-jobs-on-ci-buildkite-example" target="_blank">how to set up a new pipeline for your project in Buildkite and configure Knapsack Pro</a>. You can also check out the following example repositories for Ruby/Rails projects:
    </p>

    <ul>
      <li><a href="https://github.com/KnapsackPro/buildkite-rails-parallel-example-with-knapsack_pro" target="_blank">Buildkite Rails Parallel Example with Knapsack Pro</a></li>
      <li><a href="https://github.com/KnapsackPro/buildkite-rails-docker-parallel-example-with-knapsack_pro" target="_blank">Buildkite Rails Docker Parallel Example with Knapsack Pro</a></li>
    </ul>

    <p>
      If you want to retry single Buildkite agents (CI nodes), then you should set <a href="https://github.com/KnapsackPro/knapsack_pro-ruby#knapsack_pro_fixed_queue_split-remember-queue-split-on-retry-ci-node" target="_blank"><code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_FIXED_QUEUE_SPLIT=true</code></a>.
    </p>

    <p>
      When using the <code class="language-plaintext highlighter-rouge">docker-compose</code> plugin on Buildkite, you have to pass some environment variables to the docker container. This is needed for Knapsack Pro to work correctly:
    </p>


<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">steps</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">label</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Test"</span>
    <span class="na">parallelism</span><span class="pi">:</span> <span class="m">2</span>
    <span class="na">plugins</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">docker-compose#3.0.3</span><span class="err">:</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">app</span>
        <span class="c1"># use the proper knapsack_pro command for your test runner here</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s">bundle exec rake knapsack_pro:queue:rspec</span>
        <span class="na">config</span><span class="pi">:</span> <span class="s">docker-compose.test.yml</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">BUILDKITE_PARALLEL_JOB_COUNT</span>
          <span class="pi">-</span> <span class="s">BUILDKITE_PARALLEL_JOB</span>
          <span class="pi">-</span> <span class="s">BUILDKITE_BUILD_NUMBER</span>
          <span class="pi">-</span> <span class="s">BUILDKITE_COMMIT</span>
          <span class="pi">-</span> <span class="s">BUILDKITE_BRANCH</span>
          <span class="pi">-</span> <span class="s">BUILDKITE_BUILD_CHECKOUT_PATH</span></code></pre></figure>


  </div>

  <div id="guide-provider-semaphoreci" class="hidden">
    <h3>Step for Semaphore CI</h3>

    <h4>Semaphore 2.0 <small>(<a href="#semaphore_1_0">click here for Semaphore 1.0</a>)</small></h4>


    <p>
      Knapsack Pro supports environment variables provided by Semaphore CI 2.0 to run your tests. You need to define a few things in the <code class="language-plaintext highlighter-rouge">.semaphore/semaphore.yml</code> config file.
    </p>

    <ul>
      <li><p>You need to set <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code>. If you don’t want to commit secrets in the yml file, you can <a href="https://docs.semaphoreci.com/article/66-environment-variables-and-secrets" target="_blank" rel="nofollow">follow this guide</a>.</p></li>
      <li>You should create as many parallel jobs as you need with the <i>parallelism</i> property. Use more parallel jobs for long test suites.</li>
    </ul>

    <p>
      Full Semaphore CI 2.0 config example for a Rails project:
    </p>


<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># .semaphore/semaphore.yml</span>
<span class="c1"># Use the latest stable version of Semaphore 2.0 YML syntax:</span>
<span class="na">version</span><span class="pi">:</span> <span class="s">v1.0</span>

<span class="na">name</span><span class="pi">:</span> <span class="s">Demo Rails 5 app</span>

<span class="na">agent</span><span class="pi">:</span>
  <span class="na">machine</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">e1-standard-2</span>
    <span class="na">os_image</span><span class="pi">:</span> <span class="s">ubuntu1804</span>

<span class="na">blocks</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup</span>
    <span class="na">task</span><span class="pi">:</span>
      <span class="na">env_vars</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">RAILS_ENV</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">test</span>
      <span class="na">jobs</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">bundle</span>
          <span class="na">commands</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">checkout</span>
          <span class="pi">-</span> <span class="s">cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH-,gems-master-</span>
          <span class="pi">-</span> <span class="s">sem-version ruby 2.6.1</span>
          <span class="pi">-</span> <span class="s">bundle install --jobs=4 --retry=3 --path vendor/bundle</span>
          <span class="pi">-</span> <span class="s">cache store gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock) vendor/bundle</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">RSpec tests</span>
    <span class="na">task</span><span class="pi">:</span>
      <span class="na">env_vars</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">RAILS_ENV</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">test</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">PGHOST</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">PGUSER</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">postgres</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">your_api_token_here</span>
      <span class="na">prologue</span><span class="pi">:</span>
        <span class="na">commands</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">checkout</span>
          <span class="pi">-</span> <span class="s">cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH-,gems-master-</span>
          <span class="pi">-</span> <span class="s">sem-service start postgres</span>
          <span class="pi">-</span> <span class="s">sem-version ruby 2.6.1</span>
          <span class="pi">-</span> <span class="s">bundle install --jobs=4 --retry=3 --path vendor/bundle</span>
          <span class="pi">-</span> <span class="s">bundle exec rake db:setup</span>

      <span class="na">jobs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run tests with Knapsack Pro</span>
        <span class="na">parallelism</span><span class="pi">:</span> <span class="m">2</span>
        <span class="na">commands</span><span class="pi">:</span>
        <span class="c1"># Step for RSpec in Queue Mode</span>
        <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:queue:rspec</span>
        <span class="c1"># Step for Cucumber in Queue Mode</span>
        <span class="c1"># If you use spring gem and spring-commands-cucumber gem to start Cucumber tests faster, please set:</span>
        <span class="c1"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bundle exec spring</span>
        <span class="c1"># or alternatively you can use spring binstub:</span>
        <span class="c1"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bin/spring</span>
        <span class="c1"># Thanks to that, Cucumber will start tests faster for each batch of tests fetched from the Knapsack Pro Queue API</span>
        <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:queue:cucumber</span>

        <span class="c1"># Step for RSpec in Regular Mode</span>
        <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:rspec</span>
        <span class="c1"># Step for Cucumber in Regular Mode</span>
        <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:cucumber</span>
        <span class="c1"># Step for Minitest in Regular Mode</span>
        <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:minitest</span>
        <span class="c1"># Step for test-unit in Regular Mode</span>
        <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:test_unit</span>
        <span class="c1"># Step for Spinach in Regular Mode</span>
        <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:spinach</span></code></pre></figure>


    <h4 id="semaphore_1_0">Semaphore 1.0</h4>

    <p>
      Run the proper <code class="language-plaintext highlighter-rouge">knapsack_pro</code> command for as many threads as you need. Here is an example:
    </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Thread 1</span>
<span class="c">## Step for RSpec</span>
bundle <span class="nb">exec </span>rake knapsack_pro:rspec
<span class="c">## Step for Cucumber</span>
bundle <span class="nb">exec </span>rake knapsack_pro:cucumber
<span class="c">## Step for Minitest</span>
bundle <span class="nb">exec </span>rake knapsack_pro:minitest
<span class="c">## Step for test-unit</span>
bundle <span class="nb">exec </span>rake knapsack_pro:test_unit
<span class="c">## Step for Spinach</span>
bundle <span class="nb">exec </span>rake knapsack_pro:spinach

<span class="c"># Thread 2</span>
<span class="c">## Step for RSpec</span>
bundle <span class="nb">exec </span>rake knapsack_pro:rspec
<span class="c">## Step for Cucumber</span>
bundle <span class="nb">exec </span>rake knapsack_pro:cucumber
<span class="c">## Step for Minitest</span>
bundle <span class="nb">exec </span>rake knapsack_pro:minitest
<span class="c">## Step for test-unit</span>
bundle <span class="nb">exec </span>rake knapsack_pro:test_unit
<span class="c">## Step for Spinach</span>
bundle <span class="nb">exec </span>rake knapsack_pro:spinach</code></pre></figure>


    <p>Your tests will be divided across threads.</p>

    <p>Please remember to set up the <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code> token as a global environment variable.</p>
  </div>


  <div id="guide-provider-codeship" class="hidden">
    <h3>Step for CloudBees CodeShip</h3>

    <p>
      You need to define a <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_CI_NODE_TOTAL</code> and <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_CI_NODE_INDEX</code> environment variables for each <a href="https://documentation.codeship.com/basic/builds-and-configuration/parallel-tests/#using-parallel-test-pipelines" target="_blank">parallel test pipeline</a>. Here is an example for 2 pipelines.
    </p>

    <p>First pipeline:</p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># first CI node running in parallel</span>

<span class="c"># Cucumber tests in Knapsack Pro Regular Mode</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack_pro:cucumber

<span class="c"># Cucumber tests in Knapsack Pro Queue Mode</span>
<span class="c"># If you use spring gem and spring-commands-cucumber gem to start Cucumber tests faster, please set:</span>
<span class="c"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bundle exec spring</span>
<span class="c"># or alternatively you can use spring binstub:</span>
<span class="c"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bin/spring</span>
<span class="c"># Thanks to that, Cucumber will start tests faster for each batch of tests fetched from the Knapsack Pro Queue API</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack_pro:queue:cucumber

<span class="c"># RSpec tests in Knapsack Pro Queue Mode</span>
<span class="c"># It will help balance your build because it is executed after Cucumber tests.</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack_pro:queue:rspec</code></pre></figure>


    <p>Second pipeline:</p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># second CI node running in parallel</span>

<span class="c"># Cucumber tests in Knapsack Pro Regular Mode</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>1 bundle <span class="nb">exec </span>rake knapsack_pro:cucumber

<span class="c"># Cucumber tests in Knapsack Pro Queue Mode</span>
<span class="c"># If you use spring gem and spring-commands-cucumber gem to start Cucumber tests faster, please set:</span>
<span class="c"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bundle exec spring</span>
<span class="c"># or alternatively you can use spring binstub:</span>
<span class="c"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bin/spring</span>
<span class="c"># Thanks to that, Cucumber will start tests faster for each batch of tests fetched from the Knapsack Pro Queue API</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>1 bundle <span class="nb">exec </span>rake knapsack_pro:queue:cucumber

<span class="c"># RSpec tests in Knapsack Pro Queue Mode</span>
<span class="c"># It will help balance your build because it is executed after Cucumber tests.</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>1 bundle <span class="nb">exec </span>rake knapsack_pro:queue:rspec</code></pre></figure>


    <p>
      Remember to define API tokens as <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_CUCUMBER</code> and <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code> on the <i>Environment</i> page of your project settings in CodeShip.
    </p>

    <p>
      CodeShip uses the same build number if you restart a build. Because of that, you need to set <a href="https://github.com/KnapsackPro/knapsack_pro-ruby#knapsack_pro_fixed_queue_split-remember-queue-split-on-retry-ci-node" target="_blank"><code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_FIXED_QUEUE_SPLIT=true</code></a> in order to be able to restart a CI build in Queue Mode.
    </p>
    </div>

  <div id="guide-provider-heroku-ci" class="hidden">
    <h3>Step for Heroku CI</h3>

    <p>
      You can parallelize your tests on Heroku CI using the <code class="language-plaintext highlighter-rouge">app.json</code> file.
    </p>

    <p>
      You can set the number of parallel dynos you want to run with the <code class="language-plaintext highlighter-rouge">quantity</code> value.
      Use the <code class="language-plaintext highlighter-rouge">test</code> key to run Knapsack Pro.
    </p>

    <p>
      You also need to specify the environment variable with an API token for Knapsack Pro.
      This should not be stored directly in the <code class="language-plaintext highlighter-rouge">app.json</code>, so you can add them to your pipeline’s Heroku CI settings (we show it below in the config for illustrative purposes).
    </p>


<figure class="highlight"><pre><code class="language-json" data-lang="json"><span class="err">#</span><span class="w"> </span><span class="err">app.json</span><span class="w">
</span><span class="p">{</span><span class="w">
  </span><span class="nl">"environments"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"formation"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"quantity"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"addons"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"heroku-postgresql"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bundle exec rake knapsack_pro:rspec"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"env"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="err">#</span><span class="w"> </span><span class="err">just</span><span class="w"> </span><span class="err">an</span><span class="w"> </span><span class="err">example</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">this</span><span class="w"> </span><span class="err">should</span><span class="w"> </span><span class="err">be</span><span class="w"> </span><span class="err">defined</span><span class="w"> </span><span class="err">outside</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">json</span><span class="w"> </span><span class="err">config</span><span class="w"> </span><span class="err">file</span><span class="w">
        </span><span class="nl">"KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC"</span><span class="p">:</span><span class="w"> </span><span class="s2">"rspec-token"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span></code></pre></figure>


    <p>
      Please see this article if you would like to <a href="https://knapsackpro.com/faq/question/how-to-run-multiple-test-suite-commands-in-heroku-ci" target="_blank">run multiple Knapsack Pro commands for different test runners on Heroku CI</a>.
    </p>

    <p>
      You can learn more about <a href="https://devcenter.heroku.com/articles/heroku-ci" target="_blank">Heroku CI</a>.
    </p>

  </div>

  <div id="guide-provider-appveyor" class="hidden">
    <h3>Step for AppVeyor</h3>

    <p>
      You need to define <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_CI_NODE_TOTAL</code> and <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_CI_NODE_INDEX</code> variables for each parallel job running as part of the same CI build.
    </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Step for RSpec for the first CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack_pro:rspec
<span class="c"># Step for RSpec for the second CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>1 bundle <span class="nb">exec </span>rake knapsack_pro:rspec

<span class="c"># Step for Cucumber for the first CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack_pro:cucumber
<span class="c"># Step for Cucumber for the second CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>1 bundle <span class="nb">exec </span>rake knapsack_pro:cucumber

<span class="c"># Step for Minitest for the first CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack_pro:minitest
<span class="c"># Step for Minitest for the second CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>1 bundle <span class="nb">exec </span>rake knapsack_pro:minitest

<span class="c"># Step for test-unit for the first CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack_pro:test_unit
<span class="c"># Step for test-unit for the second CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>1 bundle <span class="nb">exec </span>rake knapsack_pro:test_unit

<span class="c"># Step for Spinach for the first CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack_pro:spinach
<span class="c"># Step for Spinach for the second CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>1 bundle <span class="nb">exec </span>rake knapsack_pro:spinach</code></pre></figure>


    <p>
    Please remember to define your API token in the <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code> global environment variable.
    </p>
  </div>

  <div id="guide-provider-gitlab-ci" class="hidden">
    <h3>Step for GitLab CI</h3>

    <p>
      Remember to add your API tokens as env variables (e.g. <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_CUCUMBER</code> or <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code>) to <a href="https://gitlab.com/help/ci/variables/README.md#secret-variables" target="_blank">Secret Variables</a> in GitLab CI Settings -&gt; CI/CD Pipelines -&gt; Secret Variables.
    </p>

    <h4>GitLab CI &gt;= 11.5</h4>


<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">test</span><span class="pi">:</span>
  <span class="na">parallel</span><span class="pi">:</span> <span class="m">2</span>

  <span class="c1"># Knapsack Pro Regular Mode</span>
  <span class="na">script</span><span class="pi">:</span> <span class="s">bundle exec rake knapsack_pro:rspec</span>

  <span class="c1"># Other commands:</span>

  <span class="c1"># Knapsack Pro Regular Mode</span>
  <span class="c1"># bundle exec rake knapsack_pro:cucumber</span>
  <span class="c1"># bundle exec rake knapsack_pro:minitest</span>
  <span class="c1"># bundle exec rake knapsack_pro:test_unit</span>
  <span class="c1"># bundle exec rake knapsack_pro:spinach</span>

  <span class="c1"># Knapsack Pro Queue Mode</span>
  <span class="c1"># bundle exec rake knapsack_pro:queue:rspec</span>
  <span class="c1"># bundle exec rake knapsack_pro:queue:minitest</span>

  <span class="c1"># If you use spring gem and spring-commands-cucumber gem to start Cucumber tests faster, please set:</span>
  <span class="c1"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bundle exec spring</span>
  <span class="c1"># or alternatively you can use spring binstub:</span>
  <span class="c1"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bin/spring</span>
  <span class="c1"># Thanks to that, Cucumber will start tests faster for each batch of tests fetched from the Knapsack Pro Queue API</span>
  <span class="c1"># bundle exec rake knapsack_pro:queue:cucumber</span></code></pre></figure>


    <p>
      Find out <a href="https://docs.gitlab.com/ee/ci/yaml/#parallel" target="_blank">how to configure running parallel CI nodes in GitLab</a>.
    </p>

  <h4>GitLab CI &lt; 11.5 (old GitLab CI)</h4>

    <p>
      You need to define <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_CI_NODE_TOTAL</code> and <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_CI_NODE_INDEX</code> environment variables for each parallel job running as part of the same test stage. Here is a relevant part of the <code class="language-plaintext highlighter-rouge">.gitlab-ci.yml</code> configuration file for 2 parallel jobs:
    </p>


<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># .gitlab-ci.yml</span>
<span class="na">stages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">test</span>

<span class="na">variables</span><span class="pi">:</span>
  <span class="na">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="pi">:</span> <span class="m">2</span>

<span class="c1"># first CI node</span>
<span class="na">test_ci_node_0</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">export KNAPSACK_PRO_CI_NODE_INDEX=0</span>
    <span class="c1"># Cucumber tests in Knapsack Pro Regular Mode</span>
    <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:cucumber</span>

    <span class="c1"># Cucumber tests in Knapsack Pro Queue Mode</span>
    <span class="c1"># If you use spring gem and spring-commands-cucumber gem to start Cucumber tests faster, please set:</span>
    <span class="c1"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bundle exec spring</span>
    <span class="c1"># or alternatively you can use spring binstub:</span>
    <span class="c1"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bin/spring</span>
    <span class="c1"># Thanks to that, Cucumber will start tests faster for each batch of tests fetched from the Knapsack Pro Queue API</span>
    <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:queue:cucumber</span>

    <span class="c1"># RSpec tests in Knapsack Pro Queue Mode</span>
    <span class="c1"># It will help balance your build because it is executed after Cucumber tests.</span>
    <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:queue:rspec</span>

<span class="c1"># second CI node</span>
<span class="na">test_ci_node_1</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">test</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">export KNAPSACK_PRO_CI_NODE_INDEX=1</span>
    <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:cucumber</span>

    <span class="c1"># If you use spring gem and spring-commands-cucumber gem to start Cucumber tests faster, please set:</span>
    <span class="c1"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bundle exec spring</span>
    <span class="c1"># or alternatively you can use spring binstub:</span>
    <span class="c1"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bin/spring</span>
    <span class="c1"># Thanks to that, Cucumber will start tests faster for each batch of tests fetched from the Knapsack Pro Queue API</span>
    <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:queue:cucumber</span>

    <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:queue:rspec</span></code></pre></figure>

  </div>


  <div id="guide-provider-cirrus-ci" class="hidden">
    <h3>Step for Cirrus CI</h3>

    <p>
      You need to configure running your desired number of parallel CI nodes in Cirrus. Then, make sure you run one of the following commands on each parallel CI node:
    </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Step for RSpec</span>
bundle <span class="nb">exec </span>rake knapsack_pro:rspec

<span class="c"># Step for Cucumber</span>
bundle <span class="nb">exec </span>rake knapsack_pro:cucumber

<span class="c"># Step for Minitest</span>
bundle <span class="nb">exec </span>rake knapsack_pro:minitest

<span class="c"># Step for test-unit</span>
bundle <span class="nb">exec </span>rake knapsack_pro:test_unit

<span class="c"># Step for Spinach</span>
bundle <span class="nb">exec </span>rake knapsack_pro:spinach</code></pre></figure>


    <p>
      Please remember to define your API token in a global environment variable (e.g. <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code> for RSpec).
    </p>

    <p>
      Here is an example of a <a href="https://cirrus-ci.org/examples/#ruby" target="_blank"><code class="language-plaintext highlighter-rouge">.cirrus.yml</code> configuration file</a>.
    </p>
  </div>

  <div id="guide-provider-jenkins" class="hidden">
    <h3>Step for Jenkins</h3>

    <p>
      In order to run parallel jobs with Jenkins you should use Jenkins Pipeline.<br />
      You can learn more in this article: <a href="https://www.cloudbees.com/blog/parallelism-and-distributed-builds-jenkins" target="_blank">Parallelism and Distributed Builds with Jenkins</a>.
    </p>

    <p>
      Here is an example of a <code class="language-plaintext highlighter-rouge">Jenkinsfile</code> working with Jenkins Pipeline.
    </p>


<figure class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="n">timeout</span><span class="o">(</span><span class="nl">time:</span> <span class="mi">60</span><span class="o">,</span> <span class="nl">unit:</span> <span class="s1">'MINUTES'</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">node</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">stage</span><span class="o">(</span><span class="s1">'Checkout'</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">checkout</span><span class="o">([</span><span class="cm">/* checkout code from git */</span><span class="o">])</span>

      <span class="c1">// determine git commit hash because we need to pass it to knapsack_pro</span>
      <span class="n">COMMIT_HASH</span> <span class="o">=</span> <span class="n">sh</span><span class="o">(</span><span class="nl">returnStdout:</span> <span class="kc">true</span><span class="o">,</span> <span class="nl">script:</span> <span class="s1">'git rev-parse HEAD'</span><span class="o">).</span><span class="na">trim</span><span class="o">()</span>

      <span class="n">stash</span> <span class="s1">'source'</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kt">def</span> <span class="n">num_nodes</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span> <span class="c1">// define your total number of CI nodes (how many parallel jobs will be executed)</span>
  <span class="kt">def</span> <span class="n">nodes</span> <span class="o">=</span> <span class="o">[:]</span>

  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_nodes</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="o">;</span>
    <span class="n">nodes</span><span class="o">[</span><span class="s2">"ci_node_${i}"</span><span class="o">]</span> <span class="o">=</span> <span class="o">{</span>
      <span class="n">node</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Setup'</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">unstash</span> <span class="s1">'source'</span>
          <span class="c1">// other setup steps</span>
        <span class="o">}</span>

        <span class="kt">def</span> <span class="n">knapsack_options</span> <span class="o">=</span> <span class="s2">"""\
            KNAPSACK_PRO_CI_NODE_TOTAL=${num_nodes}\
            KNAPSACK_PRO_CI_NODE_INDEX=${index}\
            KNAPSACK_PRO_COMMIT_HASH=${COMMIT_HASH}\
            KNAPSACK_PRO_BRANCH=${env.BRANCH_NAME}\
        """</span>

        <span class="c1">// example: running cucumber tests in Knapsack Pro Regular Mode</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Run cucumber'</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"""${knapsack_options} bundle exec rake knapsack_pro:cucumber"""</span>
        <span class="o">}</span>

        <span class="c1">// example: running RSpec tests in Knapsack Pro Queue Mode</span>
        <span class="c1">// Queue Mode should be run as a last stage so it can help balance the build if tests in the Regular Mode were not perfectly distributed</span>
        <span class="n">stage</span><span class="o">(</span><span class="s1">'Run rspec'</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sh</span> <span class="s2">"""KNAPSACK_PRO_CI_NODE_BUILD_ID=${env.BUILD_TAG} ${knapsack_options} bundle exec rake knapsack_pro:queue:rspec"""</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="n">parallel</span> <span class="n">nodes</span> <span class="c1">// run CI nodes in parallel</span>
<span class="o">}</span></code></pre></figure>


    <p>
      Please remember to define your API token in a global environment variable (e.g. <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code> for RSpec).
    </p>

    <p>
      In the above example, we first run cucumber tests in the Regular Mode and then RSpec tests in the Queue Mode.
      Queue Mode assigns tests dynamically, so running it at the end helps balance the workload between the nodes.
    </p>
  </div>

  <div id="guide-provider-github-actions" class="hidden">
    <h3>Step for GitHub Actions</h3>

    <p>
      You need to define a few things in your <code class="language-plaintext highlighter-rouge">.github/workflows/main.yaml</code> config file.
    </p>

    <ul>
      <li><p>Set up your API token (e.g. <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code>) in GitHub settings -&gt; Secrets for your repository. (<a href="https://docs.github.com/en/actions/security-guides/encrypted-secrets#creating-encrypted-secrets-for-a-repository" target="_blank" rel="nofollow">More info</a>).</p></li>
      <li><p>You should create as many parallel jobs as you need with the <a href="https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix" target="_blank" rel="nofollow"><code class="language-plaintext highlighter-rouge">matrix</code> property</a>. Use more parallel jobs for slow test suites.</p></li>
    </ul>

    <p>
      Here is a full GitHub Actions config for a Ruby on Rails project:
    </p>


<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># .github/workflows/main.yaml</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">Main</span>

<span class="na">on</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">push</span><span class="pi">]</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">test</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>

    <span class="c1"># If you need a DB, then define it in the service below.</span>
    <span class="c1"># https://github.com/actions/example-services/tree/master/.github/workflows</span>
    <span class="na">services</span><span class="pi">:</span>
      <span class="na">postgres</span><span class="pi">:</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:10.8</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="na">POSTGRES_USER</span><span class="pi">:</span> <span class="s">postgres</span>
          <span class="na">POSTGRES_PASSWORD</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
          <span class="na">POSTGRES_DB</span><span class="pi">:</span> <span class="s">postgres</span>
        <span class="na">ports</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">5432:5432</span>
        <span class="c1"># needed because the postgres container does not provide a healthcheck</span>
        <span class="c1"># tmpfs makes DB faster by using RAM</span>
        <span class="na">options</span><span class="pi">:</span> <span class="pi">&gt;-</span>
          <span class="s">--mount type=tmpfs,destination=/var/lib/postgresql/data</span>
          <span class="s">--health-cmd pg_isready</span>
          <span class="s">--health-interval 10s</span>
          <span class="s">--health-timeout 5s</span>
          <span class="s">--health-retries 5</span>
      <span class="na">redis</span><span class="pi">:</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">redis</span>
        <span class="na">ports</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">6379:6379</span>
        <span class="na">options</span><span class="pi">:</span> <span class="s">--entrypoint redis-server</span>

    <span class="c1"># https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idstrategymatrix</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">fail-fast</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="c1"># [n] - where the n is a number of parallel jobs you want to run your tests on.</span>
        <span class="c1"># Use a higher number if you have slow tests to split them between more parallel jobs.</span>
        <span class="c1"># Remember to update the value of the `ci_node_index` below to (0..n-1).</span>
        <span class="na">ci_node_total</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">2</span><span class="pi">]</span>
        <span class="c1"># Indexes for parallel jobs (starting from zero).</span>
        <span class="c1"># E.g. use [0, 1] for 2 parallel jobs, [0, 1, 2] for 3 parallel jobs, etc.</span>
        <span class="na">ci_node_index</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">0</span><span class="pi">,</span> <span class="nv">1</span><span class="pi">]</span>

    <span class="na">env</span><span class="pi">:</span>
      <span class="na">RAILS_ENV</span><span class="pi">:</span> <span class="s">test</span>
      <span class="na">GEMFILE_RUBY_VERSION</span><span class="pi">:</span> <span class="s">2.7.2</span>
      <span class="na">PGHOST</span><span class="pi">:</span> <span class="s">localhost</span>
      <span class="na">PGUSER</span><span class="pi">:</span> <span class="s">postgres</span>
      <span class="c1"># Rails verifies the time zone in DB is the same as the time zone of the Rails app</span>
      <span class="na">TZ</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Europe/Warsaw"</span>

    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Ruby</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">ruby/setup-ruby@v1</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="c1"># Not needed with a .ruby-version file</span>
          <span class="na">ruby-version</span><span class="pi">:</span> <span class="m">2.7</span>
          <span class="c1"># runs 'bundle install' and caches installed gems automatically</span>
          <span class="na">bundler-cache</span><span class="pi">:</span> <span class="no">true</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create DB</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">bin/rails db:prepare</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run tests</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="na">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</span><span class="pi">:</span> <span class="s">${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC }}</span>
          <span class="na">KNAPSACK_PRO_TEST_SUITE_TOKEN_CUCUMBER</span><span class="pi">:</span> <span class="s">${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_CUCUMBER }}</span>
          <span class="na">KNAPSACK_PRO_TEST_SUITE_TOKEN_MINITEST</span><span class="pi">:</span> <span class="s">${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_MINITEST }}</span>
          <span class="na">KNAPSACK_PRO_TEST_SUITE_TEST_UNIT</span><span class="pi">:</span> <span class="s">${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_TEST_UNIT }}</span>
          <span class="na">KNAPSACK_PRO_TEST_SUITE_TOKEN_SPINACH</span><span class="pi">:</span> <span class="s">${{ secrets.KNAPSACK_PRO_TEST_SUITE_TOKEN_SPINACH }}</span>
          <span class="na">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="pi">:</span> <span class="s">${{ matrix.ci_node_total }}</span>
          <span class="na">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="pi">:</span> <span class="s">${{ matrix.ci_node_index }}</span>
          <span class="na">KNAPSACK_PRO_LOG_LEVEL</span><span class="pi">:</span> <span class="s">info</span>
          <span class="c1"># if you use Knapsack Pro Queue Mode you must set below env variable</span>
          <span class="c1"># to be able to retry CI build and run previously recorded tests</span>
          <span class="c1"># https://github.com/KnapsackPro/knapsack_pro-ruby#knapsack_pro_fixed_queue_split-remember-queue-split-on-retry-ci-node</span>
          <span class="na">KNAPSACK_PRO_FIXED_QUEUE_SPLIT</span><span class="pi">:</span> <span class="no">true</span>
          <span class="c1"># RSpec split test files by test examples feature - it's optional</span>
          <span class="c1"># https://knapsackpro.com/faq/question/how-to-split-slow-rspec-test-files-by-test-examples-by-individual-it</span>
          <span class="c1"># KNAPSACK_PRO_RSPEC_SPLIT_BY_TEST_EXAMPLES: true</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s"># run tests in Knapsack Pro Regular Mode</span>
          <span class="s">bundle exec rake knapsack_pro:rspec</span>
          <span class="s">bundle exec rake knapsack_pro:cucumber</span>
          <span class="s">bundle exec rake knapsack_pro:minitest</span>
          <span class="s">bundle exec rake knapsack_pro:test_unit</span>
          <span class="s">bundle exec rake knapsack_pro:spinach</span>
          <span class="s"># you can use Knapsack Pro in Queue Mode once recorded first CI build with Regular Mode</span>
          <span class="s">bundle exec rake knapsack_pro:queue:rspec</span>
          <span class="s">bundle exec rake knapsack_pro:queue:cucumber</span>
          <span class="s">bundle exec rake knapsack_pro:queue:minitest</span></code></pre></figure>


    <p>
      Github Actions uses the same build number if you restart a build. Because of that, you need to set <a href="https://github.com/KnapsackPro/knapsack_pro-ruby#knapsack_pro_fixed_queue_split-remember-queue-split-on-retry-ci-node" target="_blank"><code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_FIXED_QUEUE_SPLIT=true</code></a> in order to be able to restart a CI build in Queue Mode.
    </p>

  </div>

  <div id="guide-provider-codefresh" class="hidden">
    <h3>Step for Codefresh</h3>

    <p>
      You need to define a few things in your <code class="language-plaintext highlighter-rouge">.codefresh/codefresh.yml</code> config file.
    </p>

    <ul>
      <li>
        <span>
          Define an API token (e.g. <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code>) in the Codefresh dashboard. See left menu <i>Pipelines -&gt; settings (cog icon next to the pipeline) -&gt; Variables tab (see a vertical menu on the right-hand side)</i>. Add a new API token there depending on the test runner you use:
        </span>
          <ul>
            <li><span><code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code></span></li>
            <li><span><code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_CUCUMBER</code></span></li>
            <li><span><code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_MINITEST</code></span></li>
            <li><span><code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TEST_UNIT</code></span></li>
            <li><span><code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_TEST_SUITE_TOKEN_SPINACH</code></span></li>
          </ul>
      </li>
      <li>
        <span>
          Set the Codefresh YAML file path. In the Codefresh dashboard, see left menu <i>Pipelines -&gt; settings (cog icon next to pipeline) -&gt; Workflow tab (horizontal menu on the top) -&gt; Path to YAML</i> (set: <code class="language-plaintext highlighter-rouge">./.codefresh/codefresh.yml</code>).
        </span>
      </li>
      <li>
        <span>
          Define how many parallel jobs (parallel CI nodes) you want to run with the <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_CI_NODE_TOTAL</code> environment variable in the <code class="language-plaintext highlighter-rouge">.codefresh/codefresh.yml</code> file.
        </span>
      </li>
      <li>
        <span>
          Ensure that in the <code class="language-plaintext highlighter-rouge">matrix</code> section, you listed all <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_CI_NODE_INDEX</code> environment variables with values from <code class="language-plaintext highlighter-rouge">0</code> to <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_CI_NODE_TOTAL-1</code>. Codefresh will generate a matrix of parallel jobs, with each job having a distinct value for the <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_CI_NODE_INDEX</code> variable. This is needed for Knapsack Pro to work correctly.
        </span>
      </li>
    </ul>

    <p>
      Below you can find an example Codefresh YAML config and <code class="language-plaintext highlighter-rouge">Test.Dockerfile</code> used by Codefresh to run Ruby on Rails project with PostgreSQL in a Docker container.
    </p>

    <p>
      Add <code class="language-plaintext highlighter-rouge">.codefresh/codefresh.yml</code> and <code class="language-plaintext highlighter-rouge">Test.Dockerfile</code> files to your project repository.
    </p>


<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># .codefresh/codefresh.yml</span>
<span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1.0"</span>

<span class="na">stages</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">clone"</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">build"</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">tests"</span>

<span class="na">steps</span><span class="pi">:</span>
  <span class="na">main_clone</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">git-clone"</span>
    <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Cloning</span><span class="nv"> </span><span class="s">main</span><span class="nv"> </span><span class="s">repository..."</span>
    <span class="na">repo</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}"</span>
    <span class="na">revision</span><span class="pi">:</span> <span class="s2">"</span><span class="s">${{CF_BRANCH}}"</span>
    <span class="na">stage</span><span class="pi">:</span> <span class="s2">"</span><span class="s">clone"</span>
  <span class="na">BuildTestDockerImage</span><span class="pi">:</span>
    <span class="na">title</span><span class="pi">:</span> <span class="s">Building Test Docker image</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">build</span>
    <span class="na">arguments</span><span class="pi">:</span>
      <span class="na">image_name</span><span class="pi">:</span> <span class="s1">'</span><span class="s">${{CF_ACCOUNT}}/${{CF_REPO_NAME}}-test'</span>
      <span class="na">tag</span><span class="pi">:</span> <span class="s1">'</span><span class="s">${{CF_BRANCH_TAG_NORMALIZED}}-${{CF_SHORT_REVISION}}'</span>
      <span class="na">dockerfile</span><span class="pi">:</span> <span class="s">Test.Dockerfile</span>
    <span class="na">stage</span><span class="pi">:</span> <span class="s2">"</span><span class="s">build"</span>

  <span class="na">run_tests</span><span class="pi">:</span>
    <span class="na">stage</span><span class="pi">:</span> <span class="s2">"</span><span class="s">tests"</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">${{BuildTestDockerImage}}'</span>
    <span class="na">working_directory</span><span class="pi">:</span> <span class="s">/src</span>
    <span class="na">fail_fast</span><span class="pi">:</span> <span class="no">false</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">RAILS_ENV=test</span>
      <span class="c1"># set how many parallel jobs you want to run</span>
      <span class="pi">-</span> <span class="s">KNAPSACK_PRO_CI_NODE_TOTAL=2</span>
      <span class="pi">-</span> <span class="s">PGHOST=postgres</span>
      <span class="pi">-</span> <span class="s">PGUSER=rails-app-with-knapsack_pro</span>
      <span class="pi">-</span> <span class="s">PGPASSWORD=password</span>
    <span class="na">services</span><span class="pi">:</span>
      <span class="na">composition</span><span class="pi">:</span>
        <span class="na">postgres</span><span class="pi">:</span>
          <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:latest</span>
          <span class="na">environment</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">POSTGRES_DB=rails-app-with-knapsack_pro_test</span>
            <span class="pi">-</span> <span class="s">POSTGRES_PASSWORD=password</span>
            <span class="pi">-</span> <span class="s">POSTGRES_USER=rails-app-with-knapsack_pro</span>
          <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="m">5432</span>
    <span class="na">matrix</span><span class="pi">:</span>
      <span class="na">environment</span><span class="pi">:</span>
        <span class="c1"># please ensure you list indexes from 0 to N-1,</span>
        <span class="c1"># where N is the value of KNAPSACK_PRO_CI_NODE_TOTAL</span>
        <span class="pi">-</span> <span class="s">KNAPSACK_PRO_CI_NODE_INDEX=0</span>
        <span class="pi">-</span> <span class="s">KNAPSACK_PRO_CI_NODE_INDEX=1</span>
    <span class="na">commands</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">bin/rails db:prepare</span>

      <span class="c1"># run tests in Knapsack Pro Regular Mode</span>
      <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:rspec</span>
      <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:cucumber</span>
      <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:minitest</span>
      <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:test_unit</span>
      <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:spinach</span>

      <span class="c1"># you can use Knapsack Pro in Queue Mode once you recorded the CI build in the Regular Mode</span>
      <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:queue:rspec</span>
      <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:queue:cucumber</span>
      <span class="pi">-</span> <span class="s">bundle exec rake knapsack_pro:queue:minitest</span></code></pre></figure>



<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># Test.Dockerfile</span>
<span class="s">FROM ruby:2.6.5-alpine3.10</span>

<span class="c1"># Prepare Docker image for Nokogiri</span>
<span class="s">RUN apk add --update \</span>
  <span class="s">build-base \</span>
  <span class="s">libxml2-dev \</span>
  <span class="s">libxslt-dev \</span>
  <span class="s">jq \</span>
  <span class="s">nodejs \</span>
  <span class="s">npm \</span>
  <span class="s">postgresql-dev \</span>
  <span class="s">python3-dev \</span>
  <span class="s">sqlite-dev \</span>
  <span class="s">git \</span>
  <span class="s">&amp;&amp; rm -rf /var/cache/apk/*</span>

<span class="c1"># Install AWS CLI</span>
<span class="s">RUN pip3 install awscli</span>

<span class="c1"># Use libxml2, libxslt packages from alpine for building nokogiri</span>
<span class="s">RUN bundle config build.nokogiri --use-system-libraries</span>

<span class="c1"># Install Codefresh CLI</span>
<span class="s">RUN wget https://github.com/codefresh-io/cli/releases/download/v0.31.1/codefresh-v0.31.1-alpine-x64.tar.gz</span>
<span class="s">RUN tar -xf codefresh-v0.31.1-alpine-x64.tar.gz -C /usr/local/bin/</span>

<span class="s">COPY . /src</span>

<span class="s">WORKDIR /src</span>

<span class="s">RUN bundle install</span></code></pre></figure>

  </div>

  <div id="guide-provider-other" class="hidden">
    <h3>Step for other CI providers</h3>

    <p>
      Set the following global variables on your CI server.
    </p>

    <p>
      The CI server's git installation will be used to determine the branch name and current commit hash (those values are needed for Knapsack Pro).
    </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">KNAPSACK_PRO_REPOSITORY_ADAPTER</span><span class="o">=</span>git</code></pre></figure>


    <p>
      The path to the project repository on your CI server, for instance:
    </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">KNAPSACK_PRO_PROJECT_DIR</span><span class="o">=</span>/home/ubuntu/my-app-repository</code></pre></figure>


    <p>
      You can <a href="https://github.com/KnapsackPro/knapsack_pro-ruby#repository-adapter-how-to-set-up-3-of-3" target="_blank">learn more about those variables here</a> and see what to do when you don't use git.
    </p>

    <h3>Set API token</h3>

    <p>
      You must set a separate API token on your CI server for each test suite you use:
    </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash">KNAPSACK_PRO_TEST_SUITE_TOKEN_RSPEC</code></pre></figure>


    <p>
      You can generate more API tokens in your <a href="https://knapsackpro.com/dashboard" target="_blank">Knapsack Pro User Dashboard</a>
    </p>

    <h3>
      Run tests on your CI servers
    </h3>

    <p>
      You need to configure a command responsible for running tests on each CI node.<br />
      Let's assume you have 2 CI nodes. Here are the commands you need to run for each CI node.
    </p>

    <p>
      Step for RSpec
    </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Command for the first CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack_pro:rspec

<span class="c"># Command for the second CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>1 bundle <span class="nb">exec </span>rake knapsack_pro:rspec</code></pre></figure>


    <p>
      Step for Minitest
    </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Command for the first CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack_pro:minitest

<span class="c"># Command for the second CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>1 bundle <span class="nb">exec </span>rake knapsack_pro:minitest</code></pre></figure>


    <p>
      Step for test-unit
    </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Command for the first CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack_pro:test_unit

<span class="c"># Command for the second CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>1 bundle <span class="nb">exec </span>rake knapsack_pro:test_unit</code></pre></figure>


    <p>
      Step for Cucumber
    </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Command for the first CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack_pro:cucumber

<span class="c"># Command for the second CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>1 bundle <span class="nb">exec </span>rake knapsack_pro:cucumber</code></pre></figure>


    <p>
      Step for spinach
    </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Command for the first CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack_pro:spinach

<span class="c"># Command for the second CI node</span>
<span class="nv">KNAPSACK_PRO_CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">KNAPSACK_PRO_CI_NODE_INDEX</span><span class="o">=</span>1 bundle <span class="nb">exec </span>rake knapsack_pro:spinach</code></pre></figure>


    <p>
      If you have more CI nodes, then update accordingly:
    </p>


<figure class="highlight"><pre><code class="language-plain" data-lang="plain">KNAPSACK_PRO_CI_NODE_TOTAL - the total number of your CI nodes
KNAPSACK_PRO_CI_NODE_INDEX - the index of each CI node (starting from 0)</code></pre></figure>

  </div>
</div>

<div id="guide-final-step" class="hidden">
  <h3>
    Verify that everything works in Regular Mode (step 1 out of 3)
  </h3>

  <p>
    You are now ready to use the gem!
  </p>

  <p>
    Please push a new commit to your repository so that the knapsack_pro gem records the execution time of your test suite.
    Note that the first run will not be optimal because knapsack_pro needs first to record execution data.
  </p>

  <p>
    Visit the <a href="https://knapsackpro.com/dashboard" target="_blank">user dashboard</a> and click the <b>Show build metrics</b> button next to your API token. Click <b>Show</b> on the new build and ensure the data from all of your CI nodes has been recorded. You should see a confirmation that all of your parallel nodes have finished their work.
  </p>

  <p>
    <strong>The next test suite run on your CI will be parallelized optimally if the previous one has been recorded correctly.</strong>
  </p>

  <h3>
    Consider using the Queue Mode to balance work dynamically across CI nodes (step 2 out of 3)
  </h3>

  <p>
    Once you confirm the knapsack_pro Regular Mode works and your tests are green, you may want to <a href="https://github.com/KnapsackPro/knapsack_pro-ruby#queue-mode" target="_blank">learn about Queue Mode and how to use it</a>.
  </p>

  <p>
    <strong>Please ensure you explicitly set <code class="language-plaintext highlighter-rouge">RAILS_ENV=test</code> on your CI nodes. You can add this setting to your CI environment variables configuration. It is needed for the Queue Mode to run correctly.</strong>
  </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># Example command for the Regular Mode in RSpec</span>
bundle <span class="nb">exec </span>rake knapsack_pro:rspec

<span class="c"># Example command for the Queue Mode in RSpec &gt;= 3.x</span>
bundle <span class="nb">exec </span>rake knapsack_pro:queue:rspec

<span class="c"># Example command for the Queue Mode in Minitest</span>
bundle <span class="nb">exec </span>rake knapsack_pro:queue:minitest

<span class="c"># Example command for the Queue Mode in Cucumber</span>
<span class="c"># If you use the spring gem and spring-commands-cucumber gem to start Cucumber tests faster, please set:</span>
<span class="c"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bundle exec spring</span>
<span class="c"># or alternatively you can use spring binstub:</span>
<span class="c"># export KNAPSACK_PRO_CUCUMBER_QUEUE_PREFIX=bin/spring</span>
<span class="c"># Thanks to that, Cucumber will start tests faster for each batch of tests fetched from the Knapsack Pro Queue API</span>
bundle <span class="nb">exec </span>rake knapsack_pro:queue:cucumber</code></pre></figure>


  <p>
    We recommend using the Regular Mode first in order to record execution data for your project. You could also use the Queue Mode to do that, but it will be much slower when recording your first build. Please ensure your tests are green in the Regular Mode and there are no order-dependent test failures before trying the Queue Mode.
  </p>

  <p>
    <strong>Note for the Queue Mode:</strong> if you use a CI provider that allows you to just retry a single CI node (for instance, Travis CI allows this when tests fail only on one of the parallel CI nodes), or when you use CI nodes on servers that can be killed during runtime (for instance using Buildkite with Amazon EC2 Spot Instances/Google Cloud Preemptible that can be preempted during CI run), then in the Queue Mode you need to set the <a href="https://github.com/KnapsackPro/knapsack_pro-ruby#knapsack_pro_fixed_queue_split-remember-queue-split-on-retry-ci-node" target="_blank"><b><code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_FIXED_QUEUE_SPLIT=true</code></b></a> flag in order to handle this correctly.
  </p>

  <p>
    <strong>An important step for CI providers that allow retrying single failed CI nodes (like Buildkite)</strong>: See <a href="https://github.com/KnapsackPro/knapsack_pro-ruby#required-ci-configuration-if-you-use-retry-single-failed-ci-node-feature-on-your-ci-server-when-knapsack_pro_fixed_queue_splittrue-in-queue-mode-or-knapsack_pro_fixed_test_suite_splittrue-in-regular-mode" target="_blank">the required CI configuration if you retry single failed CI nodes on your CI server</a> when using the <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_FIXED_QUEUE_SPLIT=true</code> (for the Queue Mode) or the <code class="language-plaintext highlighter-rouge">KNAPSACK_PRO_FIXED_TEST_SUITE_SPLIT=true</code> setting (for the Regular Mode).
  </p>

  <p>
    <strong>Common problems with the Queue Mode</strong>: If you notice any test failures for RSpec when using the knapsack_pro Queue Mode, then it means that your test suite needs to be adjusted for using the <code class="language-plaintext highlighter-rouge">RSpec::Core::Runner</code> multiple times (which is what the Queue Mode does). Please see our <a href="https://knapsackpro.com/faq/question/why-when-i-use-queue-mode-for-rspec-then-my-tests-fail" target="_blank">FAQ entry for common Queue Mode problems</a>.<br />
    <br />
    If you think your problem is not covered there, please <a href="https://knapsackpro.com/contact" target="_blank">contact us</a>. We’ve seen many projects and realize that each test suite might introduce different edge cases that sometimes make RSpec fail. We’ll be happy to help you debug yours!
  </p>

  <p>
    You can learn more about custom configuration and other <a href="https://knapsackpro.com/features" target="_blank">features</a> from the <a href="https://github.com/KnapsackPro/knapsack_pro-ruby#table-of-contents" target="_blank">documentation</a>.
    If you have any problems, please check our <a href="https://knapsackpro.com/faq" target="_blank">FAQ</a>.
  </p>

  <p>
    Many people look for information on using the <a href="https://knapsackpro.com/faq/question/how-to-use-junit-formatter" target="_blank">junit formatter</a> with RSpec or Cucumber or how to use <a href="https://knapsackpro.com/faq/question/how-to-use-codeclimate-with-knapsack_pro" target="_blank">CodeClimate</a> or <a href="https://knapsackpro.com/faq/question/how-to-use-simplecov-in-queue-mode" target="_blank">SimpleCov</a> with the knapsack_pro gem.
  </p>

  <p>
    Feel free to <a href="https://knapsackpro.com/contact" target="_blank">reach out</a> if you need any help.
  </p>

  <h3>How to split slow test files across parallel CI nodes (step 3 out of 3)</h3>

  <p>
    If your test suite has very slow test files then the <a href="https://github.com/KnapsackPro/knapsack_pro-ruby#split-test-files-by-test-cases" target="_blank">slowest test files can be split across parallel CI nodes automatically by the knapsack_pro gem</a>. This works both in the Regular Mode and the Queue Mode.
  </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># enable split by test examples for the slowest RSpec test files</span>
<span class="nv">KNAPSACK_PRO_RSPEC_SPLIT_BY_TEST_EXAMPLES</span><span class="o">=</span><span class="nb">true</span></code></pre></figure>


  <p>
    If you'd like to limit the debug logs produced by the knapsack_pro gem, you can change the log level to:
  </p>


<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">KNAPSACK_PRO_LOG_LEVEL</span><span class="o">=</span>info</code></pre></figure>


  <p>You can learn more <a href="https://knapsackpro.com/faq/question/how-can-i-change-log-level" target="_blank">here</a>.</p>

  <h3>Most popular FAQ entries</h3>

  <p>
    You can find all entries in the <a href="https://knapsackpro.com/faq" target="_blank">FAQ</a>. The following are the most popular things developers ask about.
  </p>

  <p>
    <ul>
      <li><a href="https://knapsackpro.com/faq/question/why-when-i-use-queue-mode-for-rspec-then-my-tests-fail" target="_blank">RSpec tests failing in the Queue Mode</a></li>
      <li><a href="https://github.com/KnapsackPro/knapsack_pro-ruby#knapsack_pro_fixed_queue_split-remember-queue-split-on-retry-ci-node" target="_blank">Retrying a single failed CI node in the Queue Mode</a> - If your CI provider allows retrying just a single CI node, then you should set KNAPSACK_PRO_FIXED_QUEUE_SPLIT=true to allow Knapsack Pro to remember what tests were executed on the particular CI node.</li>
      <li><a href="https://knapsackpro.com/faq/question/why-knapsack_pro-hangs--freezes--is-stale-ie-for-codeship-in-queue-mode" target="_blank">CI tests output freezing</a></li>
      <li><a href="https://knapsackpro.com/faq/question/how-to-use-junit-formatter" target="_blank">Using JUnit formatter with Knapsack Pro</a></li>
      <li><a href="https://knapsackpro.com/faq/question/how-to-use-simplecov-in-queue-mode" target="_blank">Using simplecov in the Queue Mode</a></li>
      <li><a href="https://knapsackpro.com/faq/question/how-to-use-codeclimate-with-knapsack_pro" target="_blank">Using CodeClimate with Knapsack Pro</a></li>
      <li><a href="https://github.com/KnapsackPro/knapsack_pro-ruby#test-file-names-encryption" target="_blank">Encrypting test file names for Ruby tests</a></li>
      <li><a href="https://knapsackpro.com/faq/question/what-data-is-sent-to-your-servers" target="_blank">Questions around data usage and security</a> - Knapsack Pro does not have access to your project source code. It collects only branch names, git commit hashes and test file paths along with their execution time.</li>
      <li><a href="https://knapsackpro.com/faq/question/how-can-i-run-tests-from-multiple-directories" target="_blank">Running selected tests based on a pattern</a> - set the KNAPSACK_PRO_TEST_FILE_PATTERN instead of passing the --pattern option to RSpec</li>
      <li><a href="https://knapsackpro.com/faq/question/how-to-run-a-specific-list-of-test-files-or-only-some-tests-from-test-file" target="_blank">Running a specific list of test files or only some test examples</a></li>
      <li><a href="https://knapsackpro.com/faq/question/how-to-exclude-tests-from-running-them" target="_blank">Excluding selected tests</a></li>
    </ul>
  </p>
</div>

  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Blog about testing & documentation for KnapsackPro.com</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Found a typo? Want to contribute?</li>
          <li><a href="https://github.com/KnapsackPro/docs.knapsackpro.com">Source Code of this site</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          <li><i class="fab fa-youtube"></i> <a href="https://www.youtube.com/c/ArturTrzop" rel="nofollow noopener" target="_blank" class="page-link">Testing tips</a></li>
          <li><i class="fab fa-twitter"></i> <a href="https://twitter.com/KnapsackPro" rel="nofollow noopener" target="_blank" class="page-link">Follow us on Twitter</a></li>
          <li><i class="fab fa-facebook-square"></i> <a href="https://www.facebook.com/KnapsackPro" rel="nofollow noopener" target="_blank" class="page-link">Like our Fanpage</a></li>
          <li><i class="fab fa-linkedin"></i> <a href="https://www.linkedin.com/company/knapsackpro/" rel="nofollow noopener" target="_blank" class="page-link">Follow us on LinkedIn</a></li>
          <li><i class="fab fa-github"></i> <a href="https://github.com/KnapsackPro" rel="nofollow noopener" target="_blank" class="page-link">GitHub</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p class="text">Speed up your tests with optimal test suite parallelisation on your CI. Blog & documentation for Knapsack Pro.</p>
      </div>
    </div>

    <div class="footer-copy">
      &copy; 2015 - 2022 <a href="https://knapsackpro.com">KnapsackPro.com</a>
    </div>

  </div>

</footer>

    <style>
  #js-cookies-message{padding: 0.5rem 1rem; display: none; opacity: 90%; text-align: center; position: fixed; bottom: 0; width: calc(100% - 2rem); background: #efefef;}
  #js-cookies-message button {cursor: pointer; border-radius: 10px; padding: 10px 20px; background-color: #0864cf; color: #fff; border: 0;}
  #js-cookies-message button:hover {background-color: #5e8fc8;}
</style>

<div id="js-cookies-message">
  <p>
    This site uses cookies. By staying here you accept them. See our <a href="https://knapsackpro.com/cookies", target="_blank">Cookie Policy</a> for details.<br>
    For more information on how to turn off the use of cookies, please <a href="https://knapsackpro.com/cookies#turning-off-cookies", target="_blank">see this</a>.<br>
    To refuse the use of cookies, please leave the page (more details <a href="https://knapsackpro.com/cookies#withdrawing-consent", target="_blank">here</a>).
  </p>
  <p>
    <a href="#" class="btn btn-primary" id="js-cookies-close"><button>I Agree</button></a>
  </p>
</div>

<script>
  $(document).ready(function() {
    var cookieName = 'cookies_consent_docs'

    if (document.cookie.includes(cookieName)) {
      // no-op
    } else {
      document.getElementById('js-cookies-message').style.display = 'block';
    };

    $("#js-cookies-close").click(function(e) {
      e.preventDefault()

      $("#js-cookies-message").fadeOut()

      var date = new Date();
      date.setMonth(date.getMonth() + 12);
      var dateString = date.toUTCString();

      document.cookie = cookieName + "=true;expires=" + dateString

      gtag('event', 'Cookie consent - I agree', {});
    });
  });
</script>

  </body>

</html>
