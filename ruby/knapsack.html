<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Knapsack gem README</title>
  <meta name="description" content="Speed up your tests with optimal test suite parallelisation on your CI. Blog & documentation for Knapsack Pro.">

  <meta property="og:title" content="Knapsack gem README">
  <meta name="twitter:title" content="Knapsack gem README">
  <meta name="twitter:description" content="Speed up your tests with optimal test suite parallelisation on your CI. Blog & documentation for Knapsack Pro.">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@KnapsackPro">

  

  <link rel="shortcut icon" href="/images/favicon.ico" />
  <link rel="stylesheet" href="/css/main.css?version=1">
  <link rel="canonical" href="https://docs.knapsackpro.com/ruby/knapsack">
  <link rel="alternate" type="application/rss+xml" title="Blog about testing & documentation for KnapsackPro.com" href="https://docs.knapsackpro.com/feed.xml" />
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:100,200,300,400,600,700&amp;subset=latin,latin-ext" type="text/css" rel="stylesheet" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
</head>


  <body>

    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JPGP34N3JJ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-JPGP34N3JJ');
</script>


    <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.6";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

    <!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');
fbq('init', '1803263473334711'); // Insert your pixel ID here.
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1803263473334711&ev=PageView&noscript=1"
/></noscript>
<!-- DO NOT MODIFY -->
<!-- End Facebook Pixel Code -->


    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://knapsackpro.com/" rel="nofollow noopener" target="_blank">
      <img src="/images/logo.png" alt="Knapsack Pro Documentation" width="32" height="32">
      Knapsack Pro&nbsp;
    </a>
    <a class="site-title" href="/integration">
      <strong>Docs</strong>
    </a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/blog/">Blog</a>
        <a class="page-link" href="/integration/">Get started with integration</a>
        <a class="page-link" href="/api/">API</a>
        <a class="page-link" href="https://knapsackpro.com">Sign up</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Knapsack gem README</h1>
  </header>

  <article class="post-content">
    <script>
$(document).ready(function() {
  if (document.cookie.includes("u_source")) {
    return;
  };

  var date = new Date();
  date.setMonth(date.getMonth() + 6);
  var dateString = date.toUTCString();
  var cookieAttributesString = "path=/;domain=knapsackpro.com;expires=" + dateString + ";";

  document.cookie = "u_source=docs_knapsackpro;" + cookieAttributesString;
  document.cookie = "u_medium=readme;" + cookieAttributesString;
  document.cookie = "u_campaign=knapsack_gem_readme;" + cookieAttributesString;
  document.cookie = "u_content=knapsack_gem_readme_pageview;" + cookieAttributesString;
});
</script>

<p><a href="https://github.com/KnapsackPro/knapsack">
  <span class="icon  icon--github">
    <svg viewBox="0 0 16 16">
      <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"></path>
    </svg>
  </span>
  knapsack gem on GitHub
</a> / <a href="https://github.com/KnapsackPro/docs.knapsackpro.com/blob/gh-pages/docs/ruby/knapsack/readme.md">this readme source code on GitHub</a></p>

<h1><img src="/images/docs/ruby/knapsack/knapsack-logo-@2.png" alt="Knapsack logo" /></h1>

<p><a href="http://www.youtube.com/watch?v=-Ae590hensE">Knapsack, The K is silent</a></p>

<p><a href="https://rubygems.org/gems/knapsack"><img src="https://badge.fury.io/rb/knapsack.svg" alt="Gem Version" /></a>
<a href="https://github.com/KnapsackPro/knapsack/actions/workflows/ruby.yml"><img src="https://github.com/KnapsackPro/knapsack/actions/workflows/ruby.yml/badge.svg" alt="Ruby" /></a>
<a href="https://codeclimate.com/github/KnapsackPro/knapsack"><img src="https://codeclimate.com/github/KnapsackPro/knapsack.svg" alt="Code Climate" /></a>
<a href="https://codeclimate.com/github/KnapsackPro/knapsack"><img src="https://codeclimate.com/github/KnapsackPro/knapsack/coverage.svg" alt="Coverage Status" /></a></p>

<p>Follow us on <a href="https://twitter.com/KnapsackPro">Twitter @KnapsackPro</a> and give Like on <a href="https://www.facebook.com/KnapsackPro">Facebook KnapsackPro</a></p>

<p><strong>Knapsack splits tests across CI nodes and makes sure that tests will run comparable time on each node.</strong></p>

<p>Parallel tests across CI server nodes based on each test file’s time execution. Knapsack generates a test time execution report and uses it for future test runs.</p>

<p>The knapsack gem supports:</p>

<ul>
  <li><a href="http://rspec.info">RSpec</a></li>
  <li><a href="https://cucumber.io">Cucumber</a></li>
  <li><a href="http://docs.seattlerb.org/minitest/">Minitest</a></li>
  <li><a href="https://github.com/codegram/spinach">Spinach</a></li>
  <li><a href="https://github.com/jnicklas/turnip">Turnip</a></li>
</ul>

<h3 id="without-knapsack---bad-test-suite-split">Without Knapsack - bad test suite split</h3>

<p><img src="/images/docs/ruby/knapsack/without_knapsack.png" alt="Without Knapsack gem" /></p>

<h3 id="with-knapsack---better-test-suite-split">With Knapsack - better test suite split</h3>

<p><img src="/images/docs/ruby/knapsack/with_knapsack.png" alt="With Knapsack gem" /></p>

<h3 id="with-knapsack-pro---optimal-test-suite-split">With Knapsack Pro - optimal test suite split</h3>

<p><a href="https://knapsackpro.com/?utm_source=github&amp;utm_medium=readme&amp;utm_campaign=knapsack_gem&amp;utm_content=video#x-play-how-it-works-video">Watch 1 minute video how Queue Mode works</a></p>

<p><a href="https://knapsackpro.com/?utm_source=github&amp;utm_medium=readme&amp;utm_campaign=knapsack_gem&amp;utm_content=video#x-play-how-it-works-video"><img src="https://img.youtube.com/vi/pkdLzKlnlQg/0.jpg" alt="IMAGE ALT TEXT HERE" /></a></p>

<p>To better understand it you can check examples for one of popular CI providers like:</p>

<ul>
  <li><strong>CircleCI</strong> - <a href="/2018/improve-circleci-parallelisation-for-rspec-minitest-cypress">Improve CircleCI parallelisation for RSpec, Minitest, Cypress</a></li>
  <li><strong>Heroku CI</strong> - <a href="/2018/how-to-run-parallel-dynos-on-heroku-ci-to-complete-tests-faster">How to run parallel dynos on Heroku CI to complete tests faster</a></li>
  <li><strong>Buildkite</strong> - <a href="/2017/auto-balancing-7-hours-tests-between-100-parallel-jobs-on-ci-buildkite-example">Auto balancing 7 hours tests between 100 parallel agents</a></li>
  <li><strong>Jenkins</strong> - <a href="/2018/jenkins-pipeline-how-to-run-parallel-tests-in-your-workflow-stages">Jenkins Pipeline how to run parallel tests in your workflow stages</a></li>
  <li><strong>CodeShip</strong> - <a href="/2018/how-to-run-codeship-parallel-test-pipelines-efficiently-optimal-ci-parallelization">How to run CodeShip Parallel Test Pipelines efficiently - optimal CI parallelization</a></li>
  <li><strong>Semaphore CI</strong> - <a href="/2019/run-parallel-jobs-on-semaphore-ci-2-0-to-get-faster-ci-build-time">Run parallel jobs on Semaphore CI 2.0 to get faster CI build time</a></li>
  <li><strong>Travis CI</strong> - <a href="/2018/how-to-run-travis-ci-parallel-jobs-with-build-matrix-feature-fast">How to run Travis CI parallel jobs with build matrix feature fast</a></li>
</ul>

<p>JavaScript examples for test runners:</p>

<ul>
  <li><strong>Cypress, Jest</strong> - <a href="/2018/run-javascript-e2e-tests-faster-with-cypress-on-parallel-ci-nodes">Run javascript E2E tests faster with Cypress on parallel CI nodes</a></li>
</ul>

<h3 id="features-in-knapsack-vs-knapsack_pro">Features in knapsack vs knapsack_pro</h3>

<table class="pure-table extra-margin-top-2x">
  <tr>
    <th>Feature</th>
    <th>knapsack&nbsp;gem</th>
    <th>knapsack_pro&nbsp;gem</th>
  </tr>
  <tr>
    <td>Queue mode designed for optimal dynamic test suite split</td>
    <td>✘</td>
    <td>✔</td>
  </tr>
  <tr>
    <td>Test suite split based on tests time execution</td>
    <td>✔</td>
    <td>✔</td>
  </tr>
  <tr>
    <td>Automated tests time execution recording</td>
    <td>✘</td>
    <td>✔</td>
  </tr>
  <tr>
    <td>Test suite split based on most up to date tests time execution data</td>
    <td>✘</td>
    <td>✔</td>
  </tr>
  <tr>
    <td><a href="https://knapsackpro.com/features/ruby_knapsack_pro_vs_knapsack?utm_source=github&amp;utm_medium=readme&amp;utm_campaign=knapsack_gem&amp;utm_content=show_all_features">Show all features</a></td>
    <td></td>
    <td></td>
  </tr>
</table>

<p><br /></p>

<p>How knapsack_pro makes my life easier as opposed to regular knapsack gem?</p>

<ul>
  <li>The knapsack_pro version has queue mode designed for optimal test suite split thanks to dynamic tests allocation.</li>
  <li>With the knapsack_pro version the setup and the ongoing work is easier because you don’t have to manually generate knapsack json report with test files time execution for each test suite like rspec, cucumber etc.</li>
  <li>The knapsack_pro version tracks all you branches so when your test code changes the knapsack_pro tries to provide you as optimal test suite split as possible.</li>
  <li>When your test codebase changes over time you need to manually generate a new knapsack report in free gem version which is extra overhead and waste of time of the developer.</li>
</ul>

<p><strong>Only <a href="https://github.com/KnapsackPro/knapsack_pro-ruby">knapsack_pro gem</a> has Queue Mode feature that saves optimal amount of time? Please <a href="http://knapsackpro.com?utm_source=github&amp;utm_medium=readme&amp;utm_campaign=knapsack_gem&amp;utm_content=try_knapsack_pro">visit Knapsack Pro</a>.</strong></p>

<h3 id="presentations-about-knapsack-gem">Presentations about knapsack gem</h3>

<ul>
  <li><a href="http://slides.com/arturt/parallel-tests-in-comparable-time">X 2014 Kraków Ruby User Group</a></li>
  <li><a href="http://slides.com/arturt/knapsack">VII 2014 Lunar Logic Dev Meeting</a></li>
</ul>

<h3 id="requirements">Requirements</h3>

<p><code class="language-plaintext highlighter-rouge">&gt;= Ruby 2.1.0</code></p>

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->

<ul>
  <li><a href="#update-gem">Update gem</a></li>
  <li><a href="#installation">Installation</a></li>
  <li><a href="#usage">Usage</a>
    <ul>
      <li><a href="#step-for-rspec">Step for RSpec</a></li>
      <li><a href="#step-for-cucumber">Step for Cucumber</a></li>
      <li><a href="#step-for-minitest">Step for Minitest</a></li>
      <li><a href="#step-for-spinach">Step for Spinach</a></li>
      <li><a href="#custom-configuration">Custom configuration</a></li>
      <li><a href="#common-step">Common step</a>
        <ul>
          <li><a href="#adding-or-removing-tests">Adding or removing tests</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#setup-your-ci-server">Setup your CI server</a>
    <ul>
      <li><a href="#info-about-env-variables">Info about ENV variables</a></li>
      <li><a href="#passing-arguments-to-rake-task">Passing arguments to rake task</a>
        <ul>
          <li><a href="#passing-arguments-to-rspec">Passing arguments to rspec</a></li>
          <li><a href="#passing-arguments-to-cucumber">Passing arguments to cucumber</a></li>
          <li><a href="#passing-arguments-to-minitest">Passing arguments to minitest</a></li>
          <li><a href="#passing-arguments-to-spinach">Passing arguments to spinach</a></li>
        </ul>
      </li>
      <li><a href="#knapsack-binary">Knapsack binary</a></li>
      <li><a href="#info-for-circleci-users">Info for CircleCI users</a>
        <ul>
          <li><a href="#step-1">Step 1</a></li>
          <li><a href="#step-2">Step 2</a></li>
        </ul>
      </li>
      <li><a href="#info-for-travis-users">Info for Travis users</a>
        <ul>
          <li><a href="#step-1-1">Step 1</a></li>
          <li><a href="#step-2-1">Step 2</a></li>
        </ul>
      </li>
      <li><a href="#info-for-semaphoreappcom-users">Info for semaphoreapp.com users</a>
        <ul>
          <li><a href="#step-1-2">Step 1</a></li>
          <li><a href="#step-2-2">Step 2</a>
            <ul>
              <li><a href="#semaphore-20">Semaphore 2.0</a></li>
              <li><a href="#semaphore-10">Semaphore 1.0</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#info-for-buildkitecom-users">Info for buildkite.com users</a>
        <ul>
          <li><a href="#step-1-3">Step 1</a></li>
          <li><a href="#step-2-3">Step 2</a></li>
        </ul>
      </li>
      <li><a href="#info-for-gitlab-ci-users">Info for GitLab CI users</a>
        <ul>
          <li><a href="#step-1">Step 1</a></li>
          <li><a href="#step-2">Step 2</a></li>
        </ul>
      </li>
      <li><a href="#info-for-snap-cicom-users">Info for snap-ci.com users</a>
        <ul>
          <li><a href="#step-1-4">Step 1</a></li>
          <li><a href="#step-2-4">Step 2</a></li>
        </ul>
      </li>
      <li><a href="#info-for-jenkins">Info for Jenkins</a></li>
      <li><a href="#info-for-bitbucket-pipelines">Info for BitBucket Pipelines</a></li>
    </ul>
  </li>
  <li><a href="#faq">FAQ</a>
    <ul>
      <li><a href="#how-knapsack-pro-makes-my-life-easier-as-opposed-to-knapsack-free-gem">How Knapsack Pro makes my life easier as opposed to knapsack free gem?</a></li>
      <li><a href="#what-time-offset-warning-means">What time offset warning means?</a></li>
      <li><a href="#how-to-generate-knapsack-report">How to generate knapsack report?</a></li>
      <li><a href="#what-does-leftover-specs-mean">What does “leftover specs” mean?</a></li>
      <li><a href="#why-some-of-test-files-are-still-in-leftover-specs-after-i-generate-a-new-report">Why some of test files are still in “leftover specs” after I generate a new report?</a></li>
      <li><a href="#how-can-i-run-tests-from-multiple-directories">How can I run tests from multiple directories?</a></li>
      <li><a href="#how-to-update-existing-knapsack-report-for-a-few-test-files">How to update existing knapsack report for a few test files?</a></li>
      <li><a href="#how-to-run-tests-for-particular-ci-node-in-your-development-environment">How to run tests for particular CI node in your development environment</a></li>
      <li><a href="#how-can-i-change-log-level">How can I change log level?</a></li>
    </ul>
  </li>
  <li><a href="#gem-tests">Gem tests</a>
    <ul>
      <li><a href="#spec">Spec</a></li>
      <li><a href="#spec-examples">Spec examples</a></li>
    </ul>
  </li>
  <li><a href="#contributing">Contributing</a></li>
  <li><a href="#acknowledgements">Acknowledgements</a></li>
  <li><a href="#mentions">Mentions</a></li>
</ul>

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<h2 id="update-gem">Update gem</h2>

<p>Please check <a href="https://github.com/KnapsackPro/knapsack/blob/master/CHANGELOG.md">changelog</a> before update gem. Knapsack follows <a href="http://semver.org">semantic versioning</a>.</p>

<h2 id="installation">Installation</h2>

<p>Add those lines to your application’s Gemfile:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">group</span> <span class="ss">:test</span><span class="p">,</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'knapsack'</span>
<span class="k">end</span></code></pre></figure>

<p>And then execute:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>bundle</code></pre></figure>

<p>Add this line at the bottom of <code class="language-plaintext highlighter-rouge">Rakefile</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Knapsack</span><span class="p">.</span><span class="nf">load_tasks</span> <span class="k">if</span> <span class="k">defined?</span><span class="p">(</span><span class="no">Knapsack</span><span class="p">)</span></code></pre></figure>

<h2 id="usage">Usage</h2>

<p>You can find here example of rails app with already configured knapsack.</p>

<p><a href="https://github.com/KnapsackPro/rails-app-with-knapsack">https://github.com/KnapsackPro/rails-app-with-knapsack</a></p>

<h3 id="step-for-rspec">Step for RSpec</h3>

<p>Add at the beginning of your <code class="language-plaintext highlighter-rouge">spec_helper.rb</code>:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'knapsack'</span>

<span class="c1"># CUSTOM_CONFIG_GOES_HERE</span>

<span class="no">Knapsack</span><span class="o">::</span><span class="no">Adapters</span><span class="o">::</span><span class="no">RSpecAdapter</span><span class="p">.</span><span class="nf">bind</span></code></pre></figure>

<h3 id="step-for-cucumber">Step for Cucumber</h3>

<p>Create file <code class="language-plaintext highlighter-rouge">features/support/knapsack.rb</code> and add there:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'knapsack'</span>

<span class="c1"># CUSTOM_CONFIG_GOES_HERE</span>

<span class="no">Knapsack</span><span class="o">::</span><span class="no">Adapters</span><span class="o">::</span><span class="no">CucumberAdapter</span><span class="p">.</span><span class="nf">bind</span></code></pre></figure>

<h3 id="step-for-minitest">Step for Minitest</h3>

<p>Add the Knapsack code after you load the app environment in the <code class="language-plaintext highlighter-rouge">test/test_helper.rb</code> file:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">ENV</span><span class="p">[</span><span class="s1">'RAILS_ENV'</span><span class="p">]</span> <span class="o">||=</span> <span class="s1">'test'</span>
<span class="nb">require</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'../../config/environment'</span><span class="p">,</span> <span class="kp">__FILE__</span><span class="p">)</span>
<span class="nb">require</span> <span class="s1">'rails/test_help'</span>

<span class="nb">require</span> <span class="s1">'knapsack'</span>

<span class="c1"># CUSTOM_CONFIG_GOES_HERE</span>

<span class="n">knapsack_adapter</span> <span class="o">=</span> <span class="no">Knapsack</span><span class="o">::</span><span class="no">Adapters</span><span class="o">::</span><span class="no">MinitestAdapter</span><span class="p">.</span><span class="nf">bind</span>
<span class="n">knapsack_adapter</span><span class="p">.</span><span class="nf">set_test_helper_path</span><span class="p">(</span><span class="kp">__FILE__</span><span class="p">)</span></code></pre></figure>

<h3 id="step-for-spinach">Step for Spinach</h3>

<p>Create file <code class="language-plaintext highlighter-rouge">features/support/env.rb</code> and add there:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">'knapsack'</span>

<span class="c1"># CUSTOM_CONFIG_GOES_HERE</span>

<span class="no">Knapsack</span><span class="o">::</span><span class="no">Adapters</span><span class="o">::</span><span class="no">SpinachAdapter</span><span class="p">.</span><span class="nf">bind</span></code></pre></figure>

<h3 id="custom-configuration">Custom configuration</h3>

<p>You can change default Knapsack configuration for RSpec, Cucumber, Minitest or Spinach tests. Here are examples what you can do. Put below configuration instead of <code class="language-plaintext highlighter-rouge">CUSTOM_CONFIG_GOES_HERE</code>.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Knapsack</span><span class="p">.</span><span class="nf">tracker</span><span class="p">.</span><span class="nf">config</span><span class="p">({</span>
  <span class="ss">enable_time_offset_warning: </span><span class="kp">true</span><span class="p">,</span>
  <span class="ss">time_offset_in_seconds: </span><span class="mi">30</span>
<span class="p">})</span>

<span class="no">Knapsack</span><span class="p">.</span><span class="nf">report</span><span class="p">.</span><span class="nf">config</span><span class="p">({</span>
  <span class="ss">test_file_pattern: </span><span class="s1">'spec/**{,/*/**}/*_spec.rb'</span><span class="p">,</span> <span class="c1"># default value based on adapter</span>
  <span class="ss">report_path: </span><span class="s1">'knapsack_custom_report.json'</span>
<span class="p">})</span>

<span class="c1"># you can use your own logger</span>
<span class="nb">require</span> <span class="s1">'logger'</span>
<span class="no">Knapsack</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">STDOUT</span><span class="p">)</span>
<span class="no">Knapsack</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">level</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">::</span><span class="no">INFO</span></code></pre></figure>

<h3 id="common-step">Common step</h3>

<p>Generate time execution report for your test files. Run below command on one of your CI nodes.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Step for RSpec</span>
<span class="nv">$ KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rspec spec

<span class="c"># Step for Cucumber</span>
<span class="nv">$ KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>cucumber features

<span class="c"># Step for Minitest</span>
<span class="nv">$ KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>

<span class="c"># If you use Rails 5.0.x then run this instead:</span>
<span class="nv">$ KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rake <span class="nb">test</span>

<span class="c"># If you use Rails &gt;= 5.1's SystemTest, run both unit and system tests</span>
<span class="nv">$ KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rake <span class="nb">test test</span>:system

<span class="c"># Step for Spinach</span>
<span class="nv">$ KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>spinach</code></pre></figure>

<p>Commit generated report <code class="language-plaintext highlighter-rouge">knapsack_rspec_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_cucumber_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_minitest_report.json</code> or <code class="language-plaintext highlighter-rouge">knapsack_spinach_report.json</code> into your repository.</p>

<p>This report should be updated only after you add a lot of new slow tests or you change existing ones which causes a big time execution difference between CI nodes. Either way, you will get time offset warning at the end of the rspec/cucumber/minitest results which reminds you when it’s a good time to regenerate the knapsack report.</p>

<p><code class="language-plaintext highlighter-rouge">KNAPSACK_GENERATE_REPORT</code> is truthy when <code class="language-plaintext highlighter-rouge">"true"</code> or <code class="language-plaintext highlighter-rouge">0</code>.  All other values are falsy, though
<a href="https://en.wikipedia.org/wiki/True_and_false_(commands)"><code class="language-plaintext highlighter-rouge">"false"</code>, and <code class="language-plaintext highlighter-rouge">1</code> are semantically
preferrable</a>.</p>

<h4 id="adding-or-removing-tests">Adding or removing tests</h4>

<p>There is no need to regenerate the report every time when you add/remove test file. If you remove a test file then Knapsack will ignore its entry in report. In case when you add a new file and it doesn’t already exist in report, the test file will be assigned to one of the CI node.</p>

<p>You’ll want to regenerate your execution report whenever you remove or add a test file with a long time execution  time that would affect one of the CI nodes. You will get Knapsack notification whenever is good time to regenerate report.</p>

<h2 id="setup-your-ci-server">Setup your CI server</h2>

<p>On your CI server run this command for the first CI node. Update <code class="language-plaintext highlighter-rouge">CI_NODE_INDEX</code> for the next one.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Step for RSpec</span>
<span class="nv">$ CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack:rspec

<span class="c"># Step for Cucumber</span>
<span class="nv">$ CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack:cucumber

<span class="c"># Step for Minitest</span>
<span class="nv">$ CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack:minitest

<span class="c"># Step for Spinach</span>
<span class="nv">$ CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack:spinach</code></pre></figure>

<p>You can add <code class="language-plaintext highlighter-rouge">KNAPSACK_TEST_FILE_PATTERN</code> if your tests are not in default directory. For instance:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Step for RSpec</span>
<span class="nv">$ KNAPSACK_TEST_FILE_PATTERN</span><span class="o">=</span><span class="s2">"directory_with_specs/**{,/*/**}/*_spec.rb"</span> <span class="nv">CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack:rspec

<span class="c"># Step for Cucumber</span>
<span class="nv">$ KNAPSACK_TEST_FILE_PATTERN</span><span class="o">=</span><span class="s2">"directory_with_features/**/*.feature"</span> <span class="nv">CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack:cucumber

<span class="c"># Step for Minitest</span>
<span class="nv">$ KNAPSACK_TEST_FILE_PATTERN</span><span class="o">=</span><span class="s2">"directory_with_tests/**{,/*/**}/*_spec.rb"</span> <span class="nv">CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack:minitest

<span class="c"># Step for Spinach</span>
<span class="nv">$ KNAPSACK_TEST_FILE_PATTERN</span><span class="o">=</span><span class="s2">"directory_with_features/**/*.feature"</span> <span class="nv">CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack:spinach</code></pre></figure>

<p>You can set <code class="language-plaintext highlighter-rouge">KNAPSACK_REPORT_PATH</code> if your knapsack report was saved in non default location. Example:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Step for RSpec</span>
<span class="nv">$ KNAPSACK_REPORT_PATH</span><span class="o">=</span><span class="s2">"knapsack_custom_report.json"</span> <span class="nv">CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack:rspec

<span class="c"># Step for Cucumber</span>
<span class="nv">$ KNAPSACK_REPORT_PATH</span><span class="o">=</span><span class="s2">"knapsack_custom_report.json"</span> <span class="nv">CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack:cucumber

<span class="c"># Step for Minitest</span>
<span class="nv">$ KNAPSACK_REPORT_PATH</span><span class="o">=</span><span class="s2">"knapsack_custom_report.json"</span> <span class="nv">CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack:minitest

<span class="c"># Step for Spinach</span>
<span class="nv">$ KNAPSACK_REPORT_PATH</span><span class="o">=</span><span class="s2">"knapsack_custom_report.json"</span> <span class="nv">CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">CI_NODE_INDEX</span><span class="o">=</span>0 bundle <span class="nb">exec </span>rake knapsack:spinach</code></pre></figure>

<h3 id="info-about-env-variables">Info about ENV variables</h3>

<p><code class="language-plaintext highlighter-rouge">CI_NODE_TOTAL</code> - total number CI nodes you have.</p>

<p><code class="language-plaintext highlighter-rouge">CI_NODE_INDEX</code> - index of current CI node starts from 0. Second CI node should have <code class="language-plaintext highlighter-rouge">CI_NODE_INDEX=1</code>.</p>

<p>Note some CI providers like GitLab CI have the same name of environment variable like <code class="language-plaintext highlighter-rouge">CI_NODE_INDEX</code> which starts from 1 instead of 0.
Knapsack gem will automatically pick it up and change from 1 to 0 to make knapsack work.</p>

<h3 id="passing-arguments-to-rake-task">Passing arguments to rake task</h3>

<h4 id="passing-arguments-to-rspec">Passing arguments to rspec</h4>

<p>Knapsack allows you to pass arguments through to rspec. For example if you want to run only specs that have the tag <code class="language-plaintext highlighter-rouge">focus</code>. If you do this with rspec directly it would look like:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>bundle <span class="nb">exec </span>rake rspec <span class="nt">--tag</span> focus</code></pre></figure>

<p>To do this with Knapsack you simply add your rspec arguments as parameters to the knapsack rake task.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="s2">"knapsack:rspec[--tag focus]"</span></code></pre></figure>

<p>Remember that using tags to limit which specs get run will affect the time each file takes to run. One solution to this is to generate a new <code class="language-plaintext highlighter-rouge">knapsack_rspec_report.json</code> for the commonly run scenarios.</p>

<h4 id="passing-arguments-to-cucumber">Passing arguments to cucumber</h4>

<p>Add arguments to knapsack cucumber task like this:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="s2">"knapsack:cucumber[--name feature]"</span></code></pre></figure>

<h4 id="passing-arguments-to-minitest">Passing arguments to minitest</h4>

<p>Add arguments to knapsack minitest task like this:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="s2">"knapsack:minitest[--arg_name value]"</span></code></pre></figure>

<p>For instance to run verbose tests:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="s2">"knapsack:minitest[--verbose]"</span></code></pre></figure>

<h4 id="passing-arguments-to-spinach">Passing arguments to spinach</h4>

<p>Add arguments to knapsack spinach task like this:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>bundle <span class="nb">exec </span>rake <span class="s2">"knapsack:spinach[--name feature]"</span></code></pre></figure>

<h3 id="knapsack-binary">Knapsack binary</h3>

<p>You can install knapsack globally and use binary. For instance:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>knapsack rspec <span class="s2">"--tag custom_tag_name --profile"</span>
<span class="nv">$ </span>knapsack cucumber
<span class="nv">$ </span>knapsack minitest <span class="s2">"--verbose --pride"</span>
<span class="nv">$ </span>knapsack spinach <span class="s2">"-f spinach_examples"</span></code></pre></figure>

<p><a href="https://github.com/KnapsackPro/knapsack/pull/21">Here</a> you will find example when it might be useful.</p>

<h3 id="info-for-circleci-users">Info for CircleCI users</h3>

<p>If you are using circleci.com you can omit <code class="language-plaintext highlighter-rouge">CI_NODE_TOTAL</code> and <code class="language-plaintext highlighter-rouge">CI_NODE_INDEX</code>. Knapsack will use <code class="language-plaintext highlighter-rouge">CIRCLE_NODE_TOTAL</code> and <code class="language-plaintext highlighter-rouge">CIRCLE_NODE_INDEX</code> provided by CircleCI.</p>

<p>Here is an example for test configuration in your <code class="language-plaintext highlighter-rouge">.circleci/config.yml</code> file.</p>

<h4 id="step-1">Step 1</h4>

<p>For the first time run all tests on a single CI node with enabled report generator.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># CircleCI 2.0</span>
<span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Step for RSpec</span>
  <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s"># export word is important here!</span>
    <span class="s">export KNAPSACK_GENERATE_REPORT=true</span>
    <span class="s">bundle exec rspec spec</span>

<span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Step for Cucumber</span>
  <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s"># export word is important here!</span>
    <span class="s">export KNAPSACK_GENERATE_REPORT=true</span>
    <span class="s">bundle exec cucumber features</span>

<span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Step for Minitest</span>
  <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s"># export word is important here!</span>
    <span class="s">export KNAPSACK_GENERATE_REPORT=true</span>
    <span class="s">bundle exec rake test</span>
    <span class="s"># For Rails 5.1 runs unit and system tests</span>
    <span class="s">bundle exec rake test test:system</span>

<span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Step for Spinach</span>
  <span class="na">command</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s"># export word is important here!</span>
    <span class="s">export KNAPSACK_GENERATE_REPORT=true</span>
    <span class="s">bundle exec rspec spinach</span></code></pre></figure>

<p>After tests pass on your CircleCI machine you should copy knapsack json report which is rendered at the end of rspec/cucumber/minitest results. Save it into your repository as <code class="language-plaintext highlighter-rouge">knapsack_rspec_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_cucumber_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_minitest_report.json</code> or <code class="language-plaintext highlighter-rouge">knapsack_spinach_report.json</code> file and commit.</p>

<h4 id="step-2">Step 2</h4>

<p>Now you should update test command and enable parallel. Please remember to add additional containers for your project in CircleCI settings.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># CircleCI 2.0</span>
<span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Step for RSpec</span>
  <span class="na">command</span><span class="pi">:</span> <span class="s">bundle exec rake knapsack:rspec</span>

<span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Step for Cucumber</span>
  <span class="na">command</span><span class="pi">:</span> <span class="s">bundle exec rake knapsack:cucumber</span>

<span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Step for Minitest</span>
  <span class="na">command</span><span class="pi">:</span> <span class="s">bundle exec rake knapsack:minitest</span>

<span class="pi">-</span> <span class="na">run</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Step for Spinach</span>
  <span class="na">command</span><span class="pi">:</span> <span class="s">bundle exec rake knapsack:spinach</span></code></pre></figure>

<p>Now everything should work. You will get a warning at the end of rspec/cucumber/minitest results if time execution takes too long.</p>

<h3 id="info-for-travis-users">Info for Travis users</h3>

<h4 id="step-1-1">Step 1</h4>

<p>For the first time run all tests at once with enabled report generator. Edit <code class="language-plaintext highlighter-rouge">.travis.yml</code></p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">script</span><span class="pi">:</span>
  <span class="c1"># Step for RSpec</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">KNAPSACK_GENERATE_REPORT=true</span><span class="nv"> </span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rspec</span><span class="nv"> </span><span class="s">spec"</span>

  <span class="c1"># Step for Cucumber</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">KNAPSACK_GENERATE_REPORT=true</span><span class="nv"> </span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">cucumber</span><span class="nv"> </span><span class="s">features"</span>

  <span class="c1"># Step for Minitest</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">KNAPSACK_GENERATE_REPORT=true</span><span class="nv"> </span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">test"</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">KNAPSACK_GENERATE_REPORT=true</span><span class="nv"> </span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">test</span><span class="nv"> </span><span class="s">test:system"</span> <span class="c1"># For Rails 5.1 runs unit and system tests</span>

  <span class="c1"># Step for Spinach</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">KNAPSACK_GENERATE_REPORT=true</span><span class="nv"> </span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">spinach"</span></code></pre></figure>

<p>After tests pass you should copy knapsack json report which is rendered at the end of rspec/cucumber/minitest results. Save it into your repository as <code class="language-plaintext highlighter-rouge">knapsack_rspec_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_cucumber_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_minitest_report.json</code> or <code class="language-plaintext highlighter-rouge">knapsack_spinach_report.json</code> file and commit.</p>

<h4 id="step-2-1">Step 2</h4>

<p>You can parallel your builds across virtual machines with <a href="http://docs.travis-ci.com/user/speeding-up-the-build/#Parallelizing-your-builds-across-virtual-machines">travis matrix feature</a>. Edit <code class="language-plaintext highlighter-rouge">.travis.yml</code></p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">script</span><span class="pi">:</span>
  <span class="c1"># Step for RSpec</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack:rspec"</span>

  <span class="c1"># Step for Cucumber</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack:cucumber"</span>

  <span class="c1"># Step for Minitest</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack:minitest"</span>

  <span class="c1"># Step for Spinach</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack:spinach"</span>

<span class="na">env</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">CI_NODE_TOTAL=2 CI_NODE_INDEX=0</span>
  <span class="pi">-</span> <span class="s">CI_NODE_TOTAL=2 CI_NODE_INDEX=1</span></code></pre></figure>

<p>If you want to have some global ENVs and matrix of ENVs then do it like this:</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">script</span><span class="pi">:</span>
  <span class="c1"># Step for RSpec</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack:rspec"</span>

  <span class="c1"># Step for Cucumber</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack:cucumber"</span>

  <span class="c1"># Step for Minitest</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack:minitest"</span>

  <span class="c1"># Step for Spinach</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">bundle</span><span class="nv"> </span><span class="s">exec</span><span class="nv"> </span><span class="s">rake</span><span class="nv"> </span><span class="s">knapsack:spinach"</span>

<span class="na">env</span><span class="pi">:</span>
  <span class="na">global</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">RAILS_ENV=test</span>
    <span class="pi">-</span> <span class="s">MY_GLOBAL_VAR=123</span>
    <span class="pi">-</span> <span class="s">CI_NODE_TOTAL=2</span>
  <span class="na">jobs</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">CI_NODE_INDEX=0</span>
    <span class="pi">-</span> <span class="s">CI_NODE_INDEX=1</span></code></pre></figure>

<p>Such configuration will generate matrix with 2 following ENV rows:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">CI_NODE_INDEX</span><span class="o">=</span>0 <span class="nv">RAILS_ENV</span><span class="o">=</span><span class="nb">test </span><span class="nv">MY_GLOBAL_VAR</span><span class="o">=</span>123
<span class="nv">CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">CI_NODE_INDEX</span><span class="o">=</span>1 <span class="nv">RAILS_ENV</span><span class="o">=</span><span class="nb">test </span><span class="nv">MY_GLOBAL_VAR</span><span class="o">=</span>123</code></pre></figure>

<p>More info about global and matrix ENV configuration in <a href="http://docs.travis-ci.com/user/build-configuration/#Environment-variables">travis docs</a>.</p>

<h3 id="info-for-semaphoreappcom-users">Info for semaphoreapp.com users</h3>

<h4 id="step-1-2">Step 1</h4>

<p>For the first time run all tests at once with enabled report generator. Set up your build command:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Step for RSpec</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rspec spec

<span class="c"># Step for Cucumber</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>cucumber features

<span class="c"># Step for Minitest</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rake <span class="nb">test
</span><span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rake <span class="nb">test test</span>:system <span class="c"># For Rails 5.1 runs unit and system tests</span>

<span class="c"># Step for Spinach</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>spinach</code></pre></figure>

<p>After tests pass you should copy knapsack json report which is rendered at the end of rspec/cucumber/test results. Save it into your repository as <code class="language-plaintext highlighter-rouge">knapsack_rspec_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_cucumber_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_minitest_report.json</code> or <code class="language-plaintext highlighter-rouge">knapsack_spinach_report.json</code> file and commit.</p>

<h4 id="step-2-2">Step 2</h4>

<h5 id="semaphore-20">Semaphore 2.0</h5>

<p>knapsack gem supports environment variables provided by Semaphore CI 2.0 to run your tests. You will have to define a few things in <code class="language-plaintext highlighter-rouge">.semaphore/semaphore.yml</code> config file.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># .semaphore/semaphore.yml</span>
<span class="c1"># Use the latest stable version of Semaphore 2.0 YML syntax:</span>
<span class="na">version</span><span class="pi">:</span> <span class="s">v1.0</span>

<span class="c1"># Name your pipeline. In case you connect multiple pipelines with promotions,</span>
<span class="c1"># the name will help you differentiate between, for example, a CI build phase</span>
<span class="c1"># and delivery phases.</span>
<span class="na">name</span><span class="pi">:</span> <span class="s">Demo Rails 5 app</span>

<span class="c1"># An agent defines the environment in which your code runs.</span>
<span class="c1"># It is a combination of one of available machine types and operating</span>
<span class="c1"># system images.</span>
<span class="c1"># See https://docs.semaphoreci.com/article/20-machine-types</span>
<span class="c1"># and https://docs.semaphoreci.com/article/32-ubuntu-1804-image</span>
<span class="na">agent</span><span class="pi">:</span>
  <span class="na">machine</span><span class="pi">:</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">e1-standard-2</span>
    <span class="na">os_image</span><span class="pi">:</span> <span class="s">ubuntu1804</span>

<span class="c1"># Blocks are the heart of a pipeline and are executed sequentially.</span>
<span class="c1"># Each block has a task that defines one or more jobs. Jobs define the</span>
<span class="c1"># commands to execute.</span>
<span class="c1"># See https://docs.semaphoreci.com/article/62-concepts</span>
<span class="na">blocks</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Setup</span>
    <span class="na">task</span><span class="pi">:</span>
      <span class="na">env_vars</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">RAILS_ENV</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">test</span>
      <span class="na">jobs</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">bundle</span>
          <span class="na">commands</span><span class="pi">:</span>
          <span class="c1"># Checkout code from Git repository. This step is mandatory if the</span>
          <span class="c1"># job is to work with your code.</span>
          <span class="c1"># Optionally you may use --use-cache flag to avoid roundtrip to</span>
          <span class="c1"># remote repository.</span>
          <span class="c1"># See https://docs.semaphoreci.com/article/54-toolbox-reference#libcheckout</span>
          <span class="pi">-</span> <span class="s">checkout</span>
          <span class="c1"># Restore dependencies from cache.</span>
          <span class="c1"># Read about caching: https://docs.semaphoreci.com/article/54-toolbox-reference#cache</span>
          <span class="pi">-</span> <span class="s">cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH-,gems-master-</span>
          <span class="c1"># Set Ruby version:</span>
          <span class="pi">-</span> <span class="s">sem-version ruby 2.6.1</span>
          <span class="pi">-</span> <span class="s">bundle install --jobs=4 --retry=3 --path vendor/bundle</span>
          <span class="c1"># Store the latest version of dependencies in cache,</span>
          <span class="c1"># to be used in next blocks and future workflows:</span>
          <span class="pi">-</span> <span class="s">cache store gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock) vendor/bundle</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">RSpec tests</span>
    <span class="na">task</span><span class="pi">:</span>
      <span class="na">env_vars</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">RAILS_ENV</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">test</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">PGHOST</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">PGUSER</span>
          <span class="na">value</span><span class="pi">:</span> <span class="s">postgres</span>
      <span class="c1"># This block runs two jobs in parallel and they both share common</span>
      <span class="c1"># setup steps. We can group them in a prologue.</span>
      <span class="c1"># See https://docs.semaphoreci.com/article/50-pipeline-yaml#prologue</span>
      <span class="na">prologue</span><span class="pi">:</span>
        <span class="na">commands</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">checkout</span>
          <span class="pi">-</span> <span class="s">cache restore gems-$SEMAPHORE_GIT_BRANCH-$(checksum Gemfile.lock),gems-$SEMAPHORE_GIT_BRANCH-,gems-master-</span>
          <span class="c1"># Start Postgres database service.</span>
          <span class="c1"># See https://docs.semaphoreci.com/article/54-toolbox-reference#sem-service</span>
          <span class="pi">-</span> <span class="s">sem-service start postgres</span>
          <span class="pi">-</span> <span class="s">sem-version ruby 2.6.1</span>
          <span class="pi">-</span> <span class="s">bundle install --jobs=4 --retry=3 --path vendor/bundle</span>
          <span class="pi">-</span> <span class="s">bundle exec rake db:setup</span>

      <span class="na">jobs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Run tests with Knapsack</span>
        <span class="na">parallelism</span><span class="pi">:</span> <span class="m">2</span>
        <span class="na">commands</span><span class="pi">:</span>
          <span class="c1"># Step for RSpec</span>
          <span class="pi">-</span> <span class="s">bundle exec rake knapsack:rspec</span>
          <span class="c1"># Step for Cucumber</span>
          <span class="pi">-</span> <span class="s">bundle exec rake knapsack:cucumber</span>
          <span class="c1"># Step for Minitest</span>
          <span class="pi">-</span> <span class="s">bundle exec rake knapsack:minitest</span>
          <span class="c1"># Step for Spinach</span>
          <span class="pi">-</span> <span class="s">bundle exec rake knapsack:spinach</span></code></pre></figure>

<p>You may also find useful article about spliting tests in a dynamic way with knapsack_pro Queue Mode: <a href="/2019/run-parallel-jobs-on-semaphore-ci-2-0-to-get-faster-ci-build-time">run parallel jobs on Semaphore CI 2.0 to get faster CI build time</a>.</p>

<h5 id="semaphore-10">Semaphore 1.0</h5>

<p>Knapsack supports semaphoreapp ENVs <code class="language-plaintext highlighter-rouge">SEMAPHORE_THREAD_COUNT</code> and <code class="language-plaintext highlighter-rouge">SEMAPHORE_CURRENT_THREAD</code>. The only thing you need to do is set up knapsack rspec/cucumber/minitest command for as many threads as you need. Here is an example:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Thread 1</span>
<span class="c">## Step for RSpec</span>
bundle <span class="nb">exec </span>rake knapsack:rspec
<span class="c">## Step for Cucumber</span>
bundle <span class="nb">exec </span>rake knapsack:cucumber
<span class="c">## Step for Minitest</span>
bundle <span class="nb">exec </span>rake knapsack:minitest
<span class="c">## Step for Spinach</span>
bundle <span class="nb">exec </span>rake knapsack:spinach

<span class="c"># Thread 2</span>
<span class="c">## Step for RSpec</span>
bundle <span class="nb">exec </span>rake knapsack:rspec
<span class="c">## Step for Cucumber</span>
bundle <span class="nb">exec </span>rake knapsack:cucumber
<span class="c">## Step for Minitest</span>
bundle <span class="nb">exec </span>rake knapsack:minitest
<span class="c">## Step for Spinach</span>
bundle <span class="nb">exec </span>rake knapsack:spinach</code></pre></figure>

<p>Tests will be split across threads.</p>

<h3 id="info-for-buildkitecom-users">Info for buildkite.com users</h3>

<h4 id="step-1-3">Step 1</h4>

<p>For the first time run all tests at once with enabled report generator. Run the following commands locally:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Step for RSpec</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rspec spec

<span class="c"># Step for Cucumber</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>cucumber features

<span class="c"># Step for Minitest</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rake <span class="nb">test
</span><span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rake <span class="nb">test test</span>:system <span class="c"># For Rails 5.1 runs unit and system tests</span>

<span class="c"># Step for Spinach</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>spinach</code></pre></figure>

<p>After tests pass you should copy knapsack json report which is rendered at the end of rspec/cucumber/minitest results. Save it into your repository as <code class="language-plaintext highlighter-rouge">knapsack_rspec_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_cucumber_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_minitest_report.json</code> or <code class="language-plaintext highlighter-rouge">knapsack_spinach_report.json</code> file and commit.</p>

<h4 id="step-2-3">Step 2</h4>

<p>Knapsack supports buildkite ENVs <code class="language-plaintext highlighter-rouge">BUILDKITE_PARALLEL_JOB_COUNT</code> and <code class="language-plaintext highlighter-rouge">BUILDKITE_PARALLEL_JOB</code>. The only thing you need to do is to configure the parallelism parameter in your build step and run the appropiate command in your build</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Step for RSpec</span>
bundle <span class="nb">exec </span>rake knapsack:rspec

<span class="c"># Step for Cucumber</span>
bundle <span class="nb">exec </span>rake knapsack:cucumber

<span class="c"># Step for Minitest</span>
bundle <span class="nb">exec </span>rake knapsack:minitest

<span class="c"># Step for Spinach</span>
bundle <span class="nb">exec </span>rake knapsack:spinach</code></pre></figure>

<p>
When using the docker-compose plugin on Buildkite, you have to tell it which environment variables to pass to the docker container:
</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">steps</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">label</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Test"</span>
    <span class="na">parallelism</span><span class="pi">:</span> <span class="m">2</span>
    <span class="na">plugins</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">docker-compose#3.0.3</span><span class="err">:</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">app</span>
        <span class="c1"># use here proper knapsack command for your test runner</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s">bundle exec rake knapsack:rspec</span>
        <span class="na">config</span><span class="pi">:</span> <span class="s">docker-compose.test.yml</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">BUILDKITE_PARALLEL_JOB_COUNT</span>
          <span class="pi">-</span> <span class="s">BUILDKITE_PARALLEL_JOB</span></code></pre></figure>

<h3 id="info-for-gitlab-ci-users">Info for GitLab CI users</h3>

<p>If you are using GitLab 11.5 or later you can omit <code class="language-plaintext highlighter-rouge">CI_NODE_TOTAL</code> and <code class="language-plaintext highlighter-rouge">CI_NODE_INDEX</code>. Knapsack will use <code class="language-plaintext highlighter-rouge">CI_NODE_TOTAL</code> and <code class="language-plaintext highlighter-rouge">CI_NODE_INDEX</code> provided by GitLab if you use the <a href="https://docs.gitlab.com/ee/ci/yaml/#parallel"><code class="language-plaintext highlighter-rouge">parallel</code></a> option in GitLab CI.</p>

<h4 id="step-1-4">Step 1</h4>

<p>For the first time run all tests on a single CI node with enabled report generator.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">test</span><span class="pi">:</span>
  <span class="na">script</span><span class="pi">:</span> <span class="s">KNAPSACK_GENERATE_REPORT=true bundle exec rspec spec</span></code></pre></figure>

<p>Here are other commands you could use instead of RSpec.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Step for Cucumber</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>cucumber features

<span class="c"># Step for Minitest</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rake <span class="nb">test
</span><span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rake <span class="nb">test test</span>:system <span class="c"># For Rails 5.1 runs unit and system tests</span>

<span class="c"># Step for Spinach</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>spinach</code></pre></figure>

<p>After tests pass on your GitLab CI you should copy knapsack json report which is rendered at the end of rspec/cucumber/minitest results. Save it into your repository as <code class="language-plaintext highlighter-rouge">knapsack_rspec_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_cucumber_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_minitest_report.json</code> or <code class="language-plaintext highlighter-rouge">knapsack_spinach_report.json</code> file and commit.</p>

<h4 id="step-2-4">Step 2</h4>

<p>Now you should update test command and enable parallel. Please remember to set proper parallel value for your project.</p>

<p>Here you can find info <a href="https://docs.gitlab.com/ee/ci/yaml/#parallel">how to configure the parallel CI nodes</a>.</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">test</span><span class="pi">:</span>
  <span class="na">script</span><span class="pi">:</span> <span class="s">bundle exec rake knapsack:rspec</span>
  <span class="na">parallel</span><span class="pi">:</span> <span class="s">2</span></code></pre></figure>

<p>Here are other commands you could use instead of knapsack for RSpec.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Step for Cucumber</span>
bundle <span class="nb">exec </span>rake knapsack:cucumber

<span class="c"># Step for Minitest</span>
bundle <span class="nb">exec </span>rake knapsack:minitest

<span class="c"># Step for Spinach</span>
bundle <span class="nb">exec </span>rake knapsack:spinach</code></pre></figure>

<h3 id="info-for-snap-cicom-users">Info for snap-ci.com users</h3>

<h4 id="step-1-5">Step 1</h4>

<p>For the first time run all tests at once with enabled report generator. Run the following commands locally:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Step for RSpec</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rspec spec

<span class="c"># Step for Cucumber</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>cucumber features

<span class="c"># Step for Minitest</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rake <span class="nb">test
</span><span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rake <span class="nb">test test</span>:system <span class="c"># For Rails 5.1 runs unit and system tests</span>

<span class="c"># Step for Spinach</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>spinach</code></pre></figure>

<p>After tests pass you should copy knapsack json report which is rendered at the end of rspec/cucumber/minitest results. Save it into your repository as <code class="language-plaintext highlighter-rouge">knapsack_rspec_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_cucumber_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_minitest_report.json</code> or <code class="language-plaintext highlighter-rouge">knapsack_spinach_report.json</code> file and commit.</p>

<h4 id="step-2-5">Step 2</h4>

<p>Knapsack supports snap-ci.com ENVs <code class="language-plaintext highlighter-rouge">SNAP_WORKER_TOTAL</code> and <code class="language-plaintext highlighter-rouge">SNAP_WORKER_INDEX</code>. The only thing you need to do is to configure number of workers for your project in configuration settings in order to enable parallelism. Next thing is to set below commands to be executed in your stage:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Step for RSpec</span>
bundle <span class="nb">exec </span>rake knapsack:rspec

<span class="c"># Step for Cucumber</span>
bundle <span class="nb">exec </span>rake knapsack:cucumber

<span class="c"># Step for Minitest</span>
bundle <span class="nb">exec </span>rake knapsack:minitest

<span class="c"># Step for Spinach</span>
bundle <span class="nb">exec </span>rake knapsack:spinach</code></pre></figure>

<h3 id="info-for-jenkins">Info for Jenkins</h3>

<p>In order to run parallel jobs with Jenkins you should use Jenkins Pipeline.
You can learn basics about it in the article <a href="https://www.cloudbees.com/blog/parallelism-and-distributed-builds-jenkins">Parallelism and Distributed Builds with Jenkins</a>.</p>

<p>Here is an example <a href="https://github.com/mknapik/jenkins-pipeline-knapsack/blob/master/Jenkinsfile"><code class="language-plaintext highlighter-rouge">Jenkinsfile</code></a> working with Jenkins Pipeline and knapsack gem.</p>

<p>You may want to read article <a href="http://blog.knapik.me/knapsack-with-jenkins-pipeline/">Knapsack with Jenkins Pipeline</a> from Michał Knapik.</p>

<p>More tips can be found in the <a href="https://github.com/KnapsackPro/knapsack/issues/42">issue</a>.</p>

<h3 id="info-for-bitbucket-pipelines">Info for BitBucket Pipelines</h3>

<h4 id="step-1-6">Step 1</h4>

<p>For the first time run all tests at once with enabled report generator. Run the following commands locally:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Step for RSpec</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rspec spec

<span class="c"># Step for Cucumber</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>cucumber features

<span class="c"># Step for Minitest</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rake <span class="nb">test
</span><span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rake <span class="nb">test test</span>:system <span class="c"># For Rails 5.1 runs unit and system tests</span>

<span class="c"># Step for Spinach</span>
<span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>spinach</code></pre></figure>

<p>After tests pass you should copy knapsack json report which is rendered at the end of rspec/cucumber/minitest results. Save it into your repository as <code class="language-plaintext highlighter-rouge">knapsack_rspec_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_cucumber_report.json</code>, <code class="language-plaintext highlighter-rouge">knapsack_minitest_report.json</code> or <code class="language-plaintext highlighter-rouge">knapsack_spinach_report.json</code> file and commit.</p>

<h4 id="step-2-6">Step 2</h4>

<p>Knapsack supports BitBucket Pipelines ENVs <code class="language-plaintext highlighter-rouge">BITBUCKET_PARALLEL_STEP_COUNT</code> and <code class="language-plaintext highlighter-rouge">BITBUCKET_PARALLEL_STEP</code>. The only thing you need to do is to configure the parallelism parameter in your build step and run the appropiate command in your build</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c"># Step for RSpec</span>
bundle <span class="nb">exec </span>rake knapsack:rspec

<span class="c"># Step for Cucumber</span>
bundle <span class="nb">exec </span>rake knapsack:cucumber

<span class="c"># Step for Minitest</span>
bundle <span class="nb">exec </span>rake knapsack:minitest

<span class="c"># Step for Spinach</span>
bundle <span class="nb">exec </span>rake knapsack:spinach</code></pre></figure>

<h2 id="faq">FAQ</h2>

<h3 id="how-knapsack-pro-makes-my-life-easier-as-opposed-to-knapsack-free-gem">How Knapsack Pro makes my life easier as opposed to knapsack free gem?</h3>

<ul>
  <li><a href="https://knapsackpro.com?utm_source=github&amp;utm_medium=readme&amp;utm_campaign=knapsack_gem&amp;utm_content=knapsack_pro_opposed_to_knapsack">Knapsack Pro</a> version has Queue Mode designed for optimal test suite split thanks to dynamic tests allocation. <a href="https://www.youtube.com/watch?v=hUEB1XDKEFY">Learn more</a></li>
  <li>Knapsack Pro version tracks all you branches so when your test code changes the Knapsack Pro tries to provide you optimal test suite split.</li>
  <li>With Knapsack Pro version the setup and the ongoing work is easier because you don’t have to manually generate knapsack json report with test files time execution for each test suite like RSpec, Cucumber etc.</li>
  <li>When your test codebase changes over time you need to manually generate a new knapsack json report in free gem version which is extra overhead and waste of developer time.</li>
</ul>

<h3 id="what-time-offset-warning-means">What time offset warning means?</h3>

<p>At the end of tests execution results you can see warning like this:</p>

<figure class="highlight"><pre><code class="language-plain" data-lang="plain">========= Knapsack Time Offset Warning ==========
Time offset: 30s
Max allowed node time execution: 02m 30s
Exceeded time: 37s</code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">Time offset: 30s</code> - this is the current time offset value, by default it’s 30s. Let’s assume whole test suite takes 4 minutes and you do split across 2 CI nodes so the optimal split is 2 minutes per node. Time offset 30s means when tests on single CI node will take longer than 2 minutes and 30s then you see warning about regenerating report because probably test suite files changed and the knapsack report contains old time execution data about each test file so regenerating knapsack report should help you provide a more optimal test suite split.</p>

<p><code class="language-plaintext highlighter-rouge">Max allowed node time execution: 02m 30s</code> - it’s average time execution of tests per CI node + time offset. In this case average tests time execution per CI node is 2 minutes.</p>

<p><code class="language-plaintext highlighter-rouge">Exceeded time: 37s</code> - it means tests on particular CI node took 37s longer than <code class="language-plaintext highlighter-rouge">max allowed node time execution</code>. Sometimes this value is negative when tests executed faster than <code class="language-plaintext highlighter-rouge">max allowed node time execution</code>.</p>

<h3 id="how-to-generate-knapsack-report">How to generate knapsack report?</h3>

<p>If you want to regenerate report take a look <a href="#common-step">here</a>.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rspec spec</code></pre></figure>

<p>If you run command like this on your development machine then test suite time execution might be different than if you generate a report on CI machine (for instance tests might be faster on your machine then on CI node) so that might be a reason why you see warning about regenerating report. You can generate the report on single CI node which should give you result specific for your CI node instead of your development machine. In case you don’t want to bother about manually regenerating knapsack report please take a look on <a href="http://knapsackpro.com?utm_source=github&amp;utm_medium=readme&amp;utm_campaign=knapsack_gem&amp;utm_content=no_manual_report">knapsack_pro gem</a>.</p>

<h3 id="what-does-leftover-specs-mean">What does “leftover specs” mean?</h3>

<p>When you run your specs with knapsack rake task then you will see in the output something like:</p>

<figure class="highlight"><pre><code class="language-plain" data-lang="plain">Report specs:
spec/models/user_spec.rb
spec/controllers/users_controller_spec.rb

Leftover specs:
spec/models/book_spec.rb
spec/models/author_spec.rb</code></pre></figure>

<p>The leftover specs mean we don’t have recorded time execution for those test files.
The reason might be:</p>

<ul>
  <li>that someone added a new test file after knapsack report was generated</li>
  <li>another reason might be an empty spec file with no test cases</li>
  <li>or you run in RSpec only subset of tests using tags like <code class="language-plaintext highlighter-rouge">--tag type:my-custom-tag</code> then if you recorded json report for such a tag then only tagged specs will be in json report and all other specs will be named as “leftover specs”</li>
</ul>

<p>If leftover specs will be distributed across CI nodes then it will happen based on file name instead of the test file execution time which is missing for them.</p>

<p>If you have a lot of leftover specs then you can <a href="#how-to-generate-knapsack-report">generate knapsack report again</a> to improve you test distribution across CI nodes.</p>

<h3 id="why-some-of-test-files-are-still-in-leftover-specs-after-i-generate-a-new-report">Why some of test files are still in “leftover specs” after I generate a new report?</h3>

<p>If test file is empty or has only pending tests then it cannot be recorded so it will end up in leftovers specs list.</p>

<h3 id="how-can-i-run-tests-from-multiple-directories">How can I run tests from multiple directories?</h3>

<p>The test file pattern config option supports any glob pattern handled by <a href="http://ruby-doc.org/core-2.2.0/Dir.html#method-c-glob"><code class="language-plaintext highlighter-rouge">Dir.glob</code></a> and can be configured to pull test files from multiple directories. An example of this when using RSpec would be <code class="language-plaintext highlighter-rouge">"{spec,engines/**/spec}/**{,/*/**}/*_spec.rb"</code>. For complex cases like this, the test directory can’t be extracted and must be specified manually using the <code class="language-plaintext highlighter-rouge">KNAPSACK_TEST_DIR</code> environment variable:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ KNAPSACK_TEST_DIR</span><span class="o">=</span>spec <span class="nv">KNAPSACK_TEST_FILE_PATTERN</span><span class="o">=</span><span class="s2">"{spec,engines/**/spec}/**{,/*/**}/*_spec.rb"</span> bundle <span class="nb">exec </span>rake knapsack:rspec</code></pre></figure>

<p><code class="language-plaintext highlighter-rouge">KNAPSACK_TEST_DIR</code> will be your default path for rspec so you should put there your <code class="language-plaintext highlighter-rouge">spec_helper.rb</code>. Please ensure you will require it in your test files this way:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># good</span>
<span class="nb">require_relative</span> <span class="s1">'spec_helper'</span>

<span class="c1"># bad - won't work</span>
<span class="nb">require</span> <span class="s1">'spec_helper'</span></code></pre></figure>

<h3 id="how-to-update-existing-knapsack-report-for-a-few-test-files">How to update existing knapsack report for a few test files?</h3>

<p>You may want to look at monkey patch in <a href="https://github.com/KnapsackPro/knapsack/issues/34">this issue</a>. Take into account that there are some cons of this approach.</p>

<h3 id="how-to-run-tests-for-particular-ci-node-in-your-development-environment">How to run tests for particular CI node in your development environment</h3>

<p>In your development environment you can debug tests that were run on the particular CI node.
For instance to run subset of tests for the first CI node with specified seed you can do.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="se">\</span>
<span class="nv">CI_NODE_INDEX</span><span class="o">=</span>0 <span class="se">\</span>
bundle <span class="nb">exec </span>rake <span class="s2">"knapsack:rspec[--seed 123]"</span></code></pre></figure>

<p>Above example is for RSpec. You can use respectively rake task name and token environment variable when you want to run tests for minitest, cucumber or spinach.</p>

<h3 id="how-can-i-change-log-level">How can I change log level?</h3>

<p>You can change log level by specifying the <code class="language-plaintext highlighter-rouge">KNAPSACK_LOG_LEVEL</code> environment variable.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">KNAPSACK_LOG_LEVEL</span><span class="o">=</span>warn bundle <span class="nb">exec </span>rake knapsack:rspec</code></pre></figure>

<p>Available values are <code class="language-plaintext highlighter-rouge">debug</code>, <code class="language-plaintext highlighter-rouge">info</code>, and <code class="language-plaintext highlighter-rouge">warn</code>. The default log level is <code class="language-plaintext highlighter-rouge">info</code>.</p>

<h2 id="gem-tests">Gem tests</h2>

<h3 id="spec">Spec</h3>

<p>To run specs for Knapsack gem type:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec spec</code></pre></figure>

<h3 id="spec-examples">Spec examples</h3>

<p>Directory <code class="language-plaintext highlighter-rouge">spec_examples</code> contains examples of fast and slow specs. There is a <code class="language-plaintext highlighter-rouge">spec_example/spec_helper.rb</code> with binded Knapsack.</p>

<p>To generate a new knapsack report for specs with <code class="language-plaintext highlighter-rouge">focus</code> tag (only specs in <code class="language-plaintext highlighter-rouge">spec_examples/leftover</code> directory have no <code class="language-plaintext highlighter-rouge">focus</code> tag), please type:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ KNAPSACK_GENERATE_REPORT</span><span class="o">=</span><span class="nb">true </span>bundle <span class="nb">exec </span>rspec <span class="nt">--default-path</span> spec_examples <span class="nt">--tag</span> focus</code></pre></figure>

<p><strong>Warning:</strong> Current <code class="language-plaintext highlighter-rouge">knapsack_rspec_report.json</code> file was generated for <code class="language-plaintext highlighter-rouge">spec_examples</code> except <code class="language-plaintext highlighter-rouge">spec_examples/leftover</code> directory. Just for testing reason to see how leftover specs will be distribute in a dumb way across CI nodes.</p>

<p>To see specs distributed for the first CI node type:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ CI_NODE_TOTAL</span><span class="o">=</span>2 <span class="nv">CI_NODE_INDEX</span><span class="o">=</span>0 <span class="nv">KNAPSACK_SPEC_PATTERN</span><span class="o">=</span><span class="s2">"spec_examples/**{,/*/**}/*_spec.rb"</span> bundle <span class="nb">exec </span>rake knapsack:rspec</code></pre></figure>

<p>Specs in <code class="language-plaintext highlighter-rouge">spec_examples/leftover</code> take more than 3 seconds. This should cause a Knapsack time offset warning because we set <code class="language-plaintext highlighter-rouge">time_offset_in_seconds</code> to 3 in <code class="language-plaintext highlighter-rouge">spec_examples/spec_helper.rb</code>. Type below to see warning:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec <span class="nt">--default-path</span> spec_examples</code></pre></figure>

<h2 id="contributing">Contributing</h2>

<ol>
  <li>Fork it ( <a href="https://github.com/KnapsackPro/knapsack/fork">https://github.com/KnapsackPro/knapsack/fork</a> )</li>
  <li>Create your feature branch (<code class="language-plaintext highlighter-rouge">git checkout -b my-new-feature</code>)</li>
  <li>Commit your changes (<code class="language-plaintext highlighter-rouge">git commit -am 'Add some feature'</code>)</li>
  <li>Push to the branch (<code class="language-plaintext highlighter-rouge">git push origin my-new-feature</code>)</li>
  <li>You can create example tests in related repository with example of <a href="https://github.com/KnapsackPro/rails-app-with-knapsack">rails application and knapsack gem usage</a>.</li>
  <li>Create a new Pull Request</li>
</ol>

<h2 id="acknowledgements">Acknowledgements</h2>

<p>Many thanks to <a href="https://github.com/informatykgosia">Małgorzata Nowak</a> for beautiful logo.</p>

<h2 id="mentions">Mentions</h2>

<ul>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Lunar Logic Blog</td>
          <td><a href="http://blog.lunarlogic.io/2014/parallel-your-specs-and-dont-waste-time/">Parallel your specs and don’t waste time</a></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Travis CI</td>
          <td><a href="http://docs.travis-ci.com/user/speeding-up-the-build/#Parallelizing-RSpec-and-Cucumber-on-multiple-VMs">Parallelizing RSpec and Cucumber on multiple VMs</a></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Semaphore</td>
          <td><a href="https://semaphoreapp.com/docs/running-rspec-specs-in-threads.html">Running RSpec specs in parallel</a></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Semaphore</td>
          <td><a href="https://semaphoreapp.com/docs/running-cucumber-scenarios-in-threads.html">Running Cucumber scenarios in parallel</a></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Buildkite</td>
          <td><a href="https://buildkite.com/docs/guides/parallelizing-builds#libraries">Libraries</a></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Snap CI</td>
          <td><a href="https://docs.snap-ci.com/speeding-up-builds/test-parallelism/#parallelism-using-third-party-tools%23knapsack-optimal-test-suite-split-based-on-time-execution">Knapsack: optimal test suite split based on time execution</a></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>CircleCI</td>
          <td><a href="https://circleci.com/docs/2.0/parallelism-faster-jobs/#other-ways-to-split-tests">Test splitting documentation</a></td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Michał Knapik Blog</td>
          <td><a href="http://blog.knapik.me/knapsack-with-jenkins-pipeline/">Knapsack with Jenkins Pipeline</a></td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

  </article>

</div>

<script>
$(document).ready(function() {
  $('h2, h3, h4, h5, h6').filter('[id]').each(function () {
    $(this).prepend('<a href="#'+$(this).attr('id')+'">&#128279;</a>&nbsp;');
  });
});
</script>


      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Blog about testing & documentation for KnapsackPro.com</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Found a typo? Want to contribute?</li>
          <li><a href="https://github.com/KnapsackPro/docs.knapsackpro.com">Source Code of this site</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          <li><i class="fab fa-youtube"></i> <a href="https://www.youtube.com/c/ArturTrzop" rel="nofollow noopener" target="_blank" class="page-link">Testing tips</a></li>
          <li><i class="fab fa-twitter"></i> <a href="https://twitter.com/KnapsackPro" rel="nofollow noopener" target="_blank" class="page-link">Follow us on Twitter</a></li>
          <li><i class="fab fa-facebook-square"></i> <a href="https://www.facebook.com/KnapsackPro" rel="nofollow noopener" target="_blank" class="page-link">Like our Fanpage</a></li>
          <li><i class="fab fa-linkedin"></i> <a href="https://www.linkedin.com/company/knapsackpro/" rel="nofollow noopener" target="_blank" class="page-link">Follow us on LinkedIn</a></li>
          <li><i class="fab fa-github"></i> <a href="https://github.com/KnapsackPro" rel="nofollow noopener" target="_blank" class="page-link">GitHub</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p class="text">Speed up your tests with optimal test suite parallelisation on your CI. Blog & documentation for Knapsack Pro.</p>
      </div>
    </div>

    <div class="footer-copy">
      &copy; 2015 - 2023 <a href="https://knapsackpro.com">KnapsackPro.com</a>
    </div>

  </div>

</footer>

    <style>
  #js-cookies-message{padding: 0.5rem 1rem; display: none; opacity: 90%; text-align: center; position: fixed; bottom: 0; width: calc(100% - 2rem); background: #efefef;}
  #js-cookies-message button {cursor: pointer; border-radius: 10px; padding: 10px 20px; background-color: #0864cf; color: #fff; border: 0;}
  #js-cookies-message button:hover {background-color: #5e8fc8;}
</style>

<div id="js-cookies-message">
  <p>
    This site uses cookies. By staying here you accept them. See our <a href="https://knapsackpro.com/cookies", target="_blank">Cookie Policy</a> for details.<br>
    For more information on how to turn off the use of cookies, please <a href="https://knapsackpro.com/cookies#turning-off-cookies", target="_blank">see this</a>.<br>
    To refuse the use of cookies, please leave the page (more details <a href="https://knapsackpro.com/cookies#withdrawing-consent", target="_blank">here</a>).
  </p>
  <p>
    <a href="#" class="btn btn-primary" id="js-cookies-close"><button>I Agree</button></a>
  </p>
</div>

<script>
  $(document).ready(function() {
    var cookieName = 'cookies_consent_docs'

    if (document.cookie.includes(cookieName)) {
      // no-op
    } else {
      document.getElementById('js-cookies-message').style.display = 'block';
    };

    $("#js-cookies-close").click(function(e) {
      e.preventDefault()

      $("#js-cookies-message").fadeOut()

      var date = new Date();
      date.setMonth(date.getMonth() + 12);
      var dateString = date.toUTCString();

      document.cookie = cookieName + "=true;expires=" + dateString + ";path=/"

      gtag('event', 'Cookie consent - I agree', {});
    });
  });
</script>

  </body>

</html>
